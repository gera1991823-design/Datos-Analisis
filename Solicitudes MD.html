<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Solicitudes - Interagrovial</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --jd-green:#184f13;
      --jd-green-dark:#0f3a0f;
      --jd-yellow:#ffde00;

      --bg:#f4faf4;
      --text:#071217;
      --row-text:#274939;
      --muted:#5f6b67;

      --border:#e8f2e8;
      --border-strong:#d7e9d7;

      --shadow:0 16px 36px rgba(15,23,32,.08);
      --shadow2:0 10px 22px rgba(15,23,32,.06);
      --radius:14px;
    }

    *{box-sizing:border-box}
    html{scrollbar-gutter: stable;}
    body{
      font-family: "Inter", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      margin: 22px;
      background: radial-gradient(1200px 600px at 15% 0%, rgba(46,125,50,.04), transparent 55%),
                  radial-gradient(1200px 600px at 85% 0%, rgba(255,222,0,.02), transparent 55%),
                  var(--bg);
      color: var(--text);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:14px;flex-wrap:wrap;margin-bottom:18px;padding:12px 14px;
      background: linear-gradient(90deg, rgba(24,79,19,0.06), rgba(255,222,0,0.02));
      border:1px solid rgba(15,64,18,.06);
      border-radius:12px;box-shadow: 0 8px 22px rgba(24,79,19,.03);
      position: relative;
    }
    .title{
      display:flex;align-items:center;gap:12px;margin:0;
      font-size:22px;font-weight:800;letter-spacing:.025em;
      color: var(--jd-green-dark);
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      background:#fff;padding:10px 18px;border-radius:10px;
      box-shadow: 0 8px 26px rgba(15,23,32,.06);
      z-index:3;border:1px solid rgba(15,23,32,.06);
    }
    @media (max-width: 720px){
      .title{position:static;transform:none;margin:0 auto;font-size:20px;padding:8px 14px}
      .topbar{padding:10px 10px}
    }
    .subpill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--border);
      padding:8px 12px;border-radius:999px;
      background: rgba(0,0,0,.03);
      font-size:12px;color:var(--muted);
      box-shadow: var(--shadow2);
    }
    .subpill b{color:var(--jd-green)}

    .card{
      background: linear-gradient(180deg, #fff, #fbfffb);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px 20px;
      box-shadow: var(--shadow);
      margin-bottom: 14px;
      overflow:hidden;
      position:relative;
      padding-left: 20px;
    }
    .accentBar{
      position:absolute;left:0;top:0;height:100%;width:10px;
      background: var(--jd-green);
      border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius);
      box-shadow: 0 8px 20px rgba(24,79,19,.06);
    }
    .cardHeader{
      display:flex;align-items:center;justify-content:flex-start;
      gap:10px;margin-bottom:12px;position:relative;min-height:56px;padding-right:12px;
      border-bottom:1px solid var(--border);padding-bottom:14px;margin-bottom:18px;
    }
    .cardHeader .row{ margin-left:auto; display:flex; gap:8px; align-items:center }
    .cardHeader h3{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      font-size:13px;padding:10px 18px;border-radius:12px;
      background: linear-gradient(90deg, rgba(255,222,0,.08), rgba(46,125,50,.04));
      color:var(--jd-green-dark);font-weight:900;text-transform:uppercase;letter-spacing:.12em;
      border:1px solid rgba(46,125,50,.10);box-shadow: 0 8px 20px rgba(24,79,19,.04);
    }
    .card > h3{
      margin:6px auto 12px;font-size:14px;padding:10px 18px;border-radius:12px;
      background: linear-gradient(90deg, rgba(255,222,0,.04), rgba(255,222,0,.02));
      color:var(--jd-green-dark);font-weight:900;text-transform:uppercase;letter-spacing:.08em;
      border:1px solid rgba(46,125,50,.06);box-shadow: 0 8px 20px rgba(24,79,19,.04);
      text-align:center;display:block;
    }
    @media (max-width:720px){
      .cardHeader h3{position:static;transform:none;margin:0 auto 10px}
      .card > h3{margin:6px 12px 12px}
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:8px;font-weight:800;text-align:center}
    .card .row > div, .card .row-add > div{display:flex;flex-direction:column;align-items:center;min-width:0}

    input,select{
      padding:10px 12px;
      border:1px solid var(--border-strong);
      border-radius:14px;
      font-size:14px;
      font-family: inherit;
      min-width:160px;
      background: rgba(0,0,0,.04);
      color: var(--text);
      outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.03);
      line-height: 1.4;
    }
    input::placeholder{color:var(--muted)}
    input:focus,select:focus{border-color: var(--jd-green-dark);box-shadow: 0 0 0 6px rgba(24,79,19,.12);}

    button{
      padding:10px 12px;border:1px solid var(--border-strong);
      background: rgba(0,0,0,.04);
      border-radius:14px;cursor:pointer;
      transition:.12s ease;font-weight:900;color:var(--text);
      box-shadow: var(--shadow2);
    }
    button:hover{transform: translateY(-1px)}
    button.primary{
      background: linear-gradient(135deg, var(--jd-green), var(--jd-green-dark));
      border-color: rgba(15,64,18,.95);
      color:#fff;
      box-shadow: 0 16px 34px rgba(24,79,19,.22);
    }
    button.secondary{
      background: linear-gradient(135deg, var(--jd-yellow), #ffd600);
      border-color: rgba(24,79,19,.06);
      color: var(--jd-green-dark);
      box-shadow:none;
      font-weight:800;
    }
    button.danger{color:#ffd7dc;border-color:#5a2731;background: rgba(176,0,32,.16);}
    button.small{padding:6px 10px;border-radius:8px;font-size:11px;box-shadow:none;font-weight:700;white-space:nowrap;min-width:auto;}
    button[disabled]{opacity:.6;cursor:not-allowed;transform:none}

    .toast{margin-top:10px;font-size:13px;color:#2f7e2c;display:none;font-weight:900}
    .toast.err{color:#ff2d2d}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 14px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    thead th{
      background: rgba(0,0,0,.03);
      position:sticky;top:0;z-index:2;
      text-align:center;
    }
    th,td{
      padding:0;font-size:14px;vertical-align:middle;white-space:nowrap;text-align:center;color:var(--text);font-weight:600;
    }
    th{font-size:13px;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);padding:12px 8px;}

    .cellInner{
      display:flex;align-items:center;justify-content:center;
      padding:14px 10px;border-radius:10px;height:48px;width:100%;
      font-weight:600;color: var(--row-text);
      border:1px solid rgba(15,23,32,.04);
      box-shadow: 0 10px 18px rgba(15,23,32,.06);
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(245,253,244,0.9));
    }
    tbody tr:nth-child(odd) .cellInner{background:#eef6ef}
    tbody tr:nth-child(even) .cellInner{background:#e3eaee}
    tbody tr:hover .cellInner{background: rgba(54,124,43,.12)}

    .cellInner .cell-input{
      width:100%;
      background:#fff;
      border:1px solid rgba(46,125,50,.14);
      padding:6px 10px;height:36px;
      font-size:14px;font-weight:600;font-family:inherit;
      border-radius:10px;text-align:center;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.9), 0 6px 14px rgba(15,23,32,.04);
    }

    td:last-child{min-width:160px}
    td:last-child .cellInner{padding:6px}
    .actions{display:flex;gap:6px;justify-content:center;flex-wrap:wrap}

    .w220{min-width:220px}
    .w200{min-width:200px}
    .w160{min-width:160px}
    .w140{min-width:140px}

    .footer{
      position:fixed;left:16px;bottom:12px;font-size:12px;
      color:var(--text);background: rgba(255,255,255,.98);
      border:1px solid var(--border);
      border-left:7px solid var(--jd-green);
      padding:9px 12px;border-radius:14px;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(6px);
    }
    .footer b{color:var(--jd-green)}
  </style>
</head>

<body>
  <div class="topbar">
    <h1 class="title">Solicitudes</h1>
    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
      <div class="subpill"><b>Tabla</b> · Materiales</div>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="card">
    <div class="accentBar"></div>
    <div class="cardHeader">
      <h3>Filtros</h3>
      <div class="row" style="gap:8px">
        <button id="clearFiltersBtn" class="secondary" type="button">Limpiar</button>
        <button id="exportXlsxBtn" class="secondary" type="button">Descargar XLSX</button>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Buscar (cualquier campo)</label>
        <input id="q" class="w220" placeholder="Ej: RE504836 / S001 / Solicitar..." />
      </div>

      <div>
        <label>Sucursal</label>
        <select id="fSucursal" class="w160">
          <option value="">(Todas)</option>
        </select>
      </div>

      <div>
        <label>Comentario</label>
        <select id="fComentario" class="w200">
          <option value="">(Todos)</option>
          <option value="Solicitar cotizacion">Solicitar cotizacion</option>
          <option value="Stock en la red">Stock en la red</option>
          <option value="Ticket reserva">Ticket reserva</option>
        </select>
      </div>

      <div>
        <label>Respuesta</label>
        <select id="fRespuesta" class="w160">
          <option value="">(Todas)</option>
          <option value="Solicitar">Solicitar</option>
          <option value="No solicitar">No solicitar</option>
        </select>
      </div>
    </div>
  </div>

  <!-- AGREGAR -->
  <div class="card">
    <div class="accentBar"></div>
    <h3>Agregar fila</h3>

    <div class="row row-add">
      <div><label>Material</label><input id="a_material" class="w160" placeholder="RE504836"></div>
      <div><label>Cantidad</label><input id="a_cantidad" class="w140" type="number" min="0" step="1" value="1"></div>
      <div><label>Solicitud</label><input id="a_solicitud" class="w160"></div>
      <div><label>Necesidad</label><input id="a_necesidad" class="w160"></div>

      <div>
        <label>Sucursal (Centro)</label>
        <select id="a_sucursal" class="w160"></select>
      </div>

      <div>
        <label>Sucursal (Nombre)</label>
        <select id="a_sucursal_nombre" class="w200"></select>
      </div>

      <div>
        <label>Nombre</label>
        <select id="a_nombre" class="w220"></select>
      </div>

      <div><label>Responsable</label><input id="a_responsable" class="w160" placeholder="Se completa solo"></div>

      <div>
        <label>Comentario</label>
        <select id="a_comentario" class="w200">
          <option value="" selected>(Elegir)</option>
          <option value="Solicitar cotizacion">Solicitar cotizacion</option>
          <option value="Stock en la red">Stock en la red</option>
          <option value="Ticket reserva">Ticket reserva</option>
        </select>
      </div>

      <div>
        <label>Respuesta</label>
        <select id="a_respuesta" class="w160">
          <option value="" selected>(Elegir)</option>
          <option value="Solicitar">Solicitar</option>
          <option value="No solicitar">No solicitar</option>
        </select>
      </div>

      <div>
        <label>Fecha de respuesta</label>
        <input id="a_fecha_respuesta" class="w160" type="date">
      </div>

      <button id="addBtn" class="primary" type="button">Agregar</button>
    </div>

    <div id="toast" class="toast"></div>

    <div id="peoplePanel" style="margin-top:12px;padding:10px;border:1px dashed var(--border);border-radius:10px;background:rgba(255,255,255,0.9)">
      <small>Seleccioná una sucursal para ver personas relacionadas.</small>
    </div>
  </div>

  <!-- TABLA -->
  <table>
    <thead>
      <tr>
        <th>Material</th>
        <th>Cantidad</th>
        <th>Solicitud</th>
        <th>Necesidad</th>
        <th>Sucursal</th>
        <th>Sucursal Nombre</th>
        <th>Responsable</th>
        <th>Comentario</th>
        <th>Respuesta</th>
        <th>Fecha de respuesta</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="footer"><b>INTERAGROVIAL S.A</b></div>

  <!-- ✅ FIREBASE + APP -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
      serverTimestamp, query, orderBy, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ✅ MISMA config que tu app de "Carpetas"
    const firebaseConfig = {
      apiKey: "AIzaSyDIGkNekvGn0XrqGvDAuutCBSglod03644",
      authDomain: "carpetas-17846.firebaseapp.com",
      projectId: "carpetas-17846",
      storageBucket: "carpetas-17846.firebasestorage.app",
      messagingSenderId: "513234224676",
      appId: "1:513234224676:web:a61b7ab9685594d1b5bab1",
      measurementId: "G-8Z18FTM0L6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);

    // ============================================================
    // ✅ DATOS YA CARGADOS (SALIDOS DE TU EXCEL - Hoja3)
    //    Columnas: Puesto | Centro | Sucursal | Nombre | Mail | Usuario SAP
    // ============================================================
    let SUCURSAL_OPTS = ["S001","S002","S003","S004","S005","S006","S007","S008","S009","S010","S011","S012","S013","S014","S015","S016","S017","S018","S019"];
    let CENTRO_OPTS = ["S001","S002","S003","S004","S005","S006","S007","S008","S009","S010","S011","S012","S013","S014","S015","S016","S017","S018","S019"];

    let SUCURSAL_NOMBRE_OPTS = ["Bodega Central","DURAZNO","FLORIDA","GOMENSORO","LASCANO","MERCEDES","MONTEVIDEO AGRO","MONTEVIDEO CONS","MVDEO/SAN JOSE","OMBUES","PAYSANDU","PAYSANDU FORESTAL","RIO BRANCO","SALTO","SAN CARLOS","SAN JOSE","TACUAREMBO","TARARIRAS","YOUNG"];

    let PUESTO_OPTS = ["Adm Tll","Adm. Analisis","Admin Rep Cons","Admin Taller","Admin Tllr","Admin. Tllr","Administr.","Amin Tll Cons","Analista","Aux -Vendedor","Aux Admin","Aux. Admin","Aux.Admin","Aux.Vendedor","Encargado","Encargado Taller","Gerente","Gte Suc","Jefe Rep.","Jefe Taller","Jefe Tallr","Jefe Tllr","Jfe Taller Cons","Responsable","Vendedor","Vendedor Jr","Vendedor Mostrador","Vtas Mostrador"];

    // centro -> array de personas {nombre, apellido, fullName, puesto, sucursalNombre, mail, usuarioSAP}
    let CENTRO_TO_PEOPLE = {"S001":[{"nombre":"Andres","apellido":"Maza","fullName":"Andres Maza","puesto":"Vendedor","sucursalNombre":"MONTEVIDEO AGRO","mail":"asmaza@isa.com.uy","usuarioSAP":"SUREP001"},{"nombre":"MARCOS","apellido":"SUASNAVAS","fullName":"MARCOS SUASNAVAS","puesto":"Vendedor","sucursalNombre":"MONTEVIDEO AGRO","mail":"msuasnavas@isa.com.uy","usuarioSAP":"SUREP002"},{"nombre":"Santiago","apellido":"Lugaro","fullName":"Santiago Lugaro","puesto":"Admin Taller","sucursalNombre":"MONTEVIDEO AGRO","mail":"slugaro@isa.com.uy","usuarioSAP":""},{"nombre":"GUSTAVO","apellido":"MIRANDA","fullName":"GUSTAVO MIRANDA","puesto":"Jefe Rep.","sucursalNombre":"MONTEVIDEO AGRO","mail":"gmiranda@isa.com.uy","usuarioSAP":"SUJRP001"},{"nombre":"Bruno","apellido":"Petrone","fullName":"Bruno Petrone","puesto":"Analista","sucursalNombre":"MONTEVIDEO AGRO","mail":"bpetrone@isa.com.uy","usuarioSAP":""},{"nombre":"CARLOS","apellido":"ROSSI","fullName":"CARLOS ROSSI","puesto":"Encargado Taller","sucursalNombre":"MONTEVIDEO AGRO","mail":"crossi@isa.com.uy","usuarioSAP":""},{"nombre":"Leonardo","apellido":"Gimenez","fullName":"Leonardo Gimenez","puesto":"Aux. Admin","sucursalNombre":"MONTEVIDEO AGRO","mail":"lgimenez@isa.com.uy","usuarioSAP":""},{"nombre":"Alejandro","apellido":"Techera","fullName":"Alejandro Techera","puesto":"Vendedor Mostrador","sucursalNombre":"MONTEVIDEO AGRO","mail":"atechera@isa.com.uy","usuarioSAP":""}],"S002":[{"nombre":"FERNANDO","apellido":"PEREZ","fullName":"FERNANDO PEREZ","puesto":"Vendedor","sucursalNombre":"MERCEDES","mail":"fperez@isa.com.uy","usuarioSAP":"SUREP006"},{"nombre":"ALVARO","apellido":"GARCIA","fullName":"ALVARO GARCIA","puesto":"Responsable","sucursalNombre":"MERCEDES","mail":"agarcia@isa.com.uy","usuarioSAP":"SURSP002"},{"nombre":"ANDREA","apellido":"SOSA","fullName":"ANDREA SOSA","puesto":"Aux. Admin","sucursalNombre":"MERCEDES","mail":"asosa@isa.com.uy","usuarioSAP":""},{"nombre":"MATIAS","apellido":"MARTINEZ","fullName":"MATIAS MARTINEZ","puesto":"Admin Taller","sucursalNombre":"MERCEDES","mail":"mmartinez@isa.com.uy","usuarioSAP":""}],"S003":[{"nombre":"GUILLERMO","apellido":"SILVA","fullName":"GUILLERMO SILVA","puesto":"Vendedor","sucursalNombre":"RIO BRANCO","mail":"gsilva@isa.com.uy","usuarioSAP":"SUREP010"},{"nombre":"JAVIER","apellido":"SOSA","fullName":"JAVIER SOSA","puesto":"Responsable","sucursalNombre":"RIO BRANCO","mail":"jsosa@isa.com.uy","usuarioSAP":"SURSP003"},{"nombre":"MARIANA","apellido":"GONZALEZ","fullName":"MARIANA GONZALEZ","puesto":"Aux. Admin","sucursalNombre":"RIO BRANCO","mail":"mgonzalez@isa.com.uy","usuarioSAP":""}],"S004":[{"nombre":"MARTIN","apellido":"PEREZ","fullName":"MARTIN PEREZ","puesto":"Vendedor","sucursalNombre":"Bodega Central","mail":"mperez@isa.com.uy","usuarioSAP":"SUREP020"},{"nombre":"SANTIAGO","apellido":"GARCIA","fullName":"SANTIAGO GARCIA","puesto":"Responsable","sucursalNombre":"Bodega Central","mail":"sgarcia@isa.com.uy","usuarioSAP":"SURSP004"}],"S005":[{"nombre":"ALBERTO","apellido":"SILVEIRA","fullName":"ALBERTO SILVEIRA","puesto":"Vendedor","sucursalNombre":"YOUNG","mail":"asilveira@isa.com.uy","usuarioSAP":"SUREP014"},{"nombre":"PABLO","apellido":"MARTINEZ","fullName":"PABLO MARTINEZ","puesto":"Responsable","sucursalNombre":"YOUNG","mail":"pmartinez@isa.com.uy","usuarioSAP":"SURSP005"},{"nombre":"ALVARO","apellido":"PEREIRA","fullName":"ALVARO PEREIRA","puesto":"Administr.","sucursalNombre":"YOUNG","mail":"apereira@isa.com.uy","usuarioSAP":""}],"S006":[{"nombre":"OSCAR","apellido":"RIVERO","fullName":"OSCAR RIVERO","puesto":"Vendedor","sucursalNombre":"PAYSANDU","mail":"orivero@isa.com.uy","usuarioSAP":"SUREP015"},{"nombre":"ENZO","apellido":"FERNANDEZ","fullName":"ENZO FERNANDEZ","puesto":"Vendedor","sucursalNombre":"PAYSANDU","mail":"efernandez@isa.com.uy","usuarioSAP":"SUREP016"},{"nombre":"EDUARDO","apellido":"FERNANDEZ","fullName":"EDUARDO FERNANDEZ","puesto":"Responsable","sucursalNombre":"PAYSANDU","mail":"edfernandez@isa.com.uy","usuarioSAP":"SURSP006"},{"nombre":"GONZALO","apellido":"GONZALEZ","fullName":"GONZALO GONZALEZ","puesto":"Administr.","sucursalNombre":"PAYSANDU","mail":"ggonzalez@isa.com.uy","usuarioSAP":""}],"S007":[{"nombre":"HUGO","apellido":"RIVERO","fullName":"HUGO RIVERO","puesto":"Vendedor","sucursalNombre":"PAYSANDU FORESTAL","mail":"hrivero@isa.com.uy","usuarioSAP":"SUREP017"},{"nombre":"OSCAR","apellido":"FERNANDEZ","fullName":"OSCAR FERNANDEZ","puesto":"Responsable","sucursalNombre":"PAYSANDU FORESTAL","mail":"offernandez@isa.com.uy","usuarioSAP":"SURSP007"},{"nombre":"ERIKA","apellido":"MARTINEZ","fullName":"ERIKA MARTINEZ","puesto":"Administr.","sucursalNombre":"PAYSANDU FORESTAL","mail":"emartinez@isa.com.uy","usuarioSAP":""}],"S008":[{"nombre":"PABLO","apellido":"SILVA","fullName":"PABLO SILVA","puesto":"Vendedor","sucursalNombre":"TARARIRAS","mail":"psilva@isa.com.uy","usuarioSAP":"SUREP008"},{"nombre":"RAFAEL","apellido":"GOMEZ","fullName":"RAFAEL GOMEZ","puesto":"Responsable","sucursalNombre":"TARARIRAS","mail":"rgomez@isa.com.uy","usuarioSAP":"SURSP008"}],"S009":[{"nombre":"MARTIN","apellido":"MARTINEZ","fullName":"MARTIN MARTINEZ","puesto":"Vendedor","sucursalNombre":"GOMENSORO","mail":"mmartin@isa.com.uy","usuarioSAP":"SUREP009"},{"nombre":"RICARDO","apellido":"SOSA","fullName":"RICARDO SOSA","puesto":"Responsable","sucursalNombre":"GOMENSORO","mail":"rsosa@isa.com.uy","usuarioSAP":"SURSP009"},{"nombre":"SANDRA","apellido":"GONZALEZ","fullName":"SANDRA GONZALEZ","puesto":"Administr.","sucursalNombre":"GOMENSORO","mail":"sgonzalez@isa.com.uy","usuarioSAP":""}],"S010":[{"nombre":"DIEGO","apellido":"PEREZ","fullName":"DIEGO PEREZ","puesto":"Vendedor","sucursalNombre":"SALTO","mail":"dperez@isa.com.uy","usuarioSAP":"SUREP011"},{"nombre":"CARLOS","apellido":"LOPEZ","fullName":"CARLOS LOPEZ","puesto":"Responsable","sucursalNombre":"SALTO","mail":"clopez@isa.com.uy","usuarioSAP":"SURSP010"}],"S011":[{"nombre":"GABRIEL","apellido":"GOMEZ","fullName":"GABRIEL GOMEZ","puesto":"Vendedor","sucursalNombre":"FLORIDA","mail":"ggomez@isa.com.uy","usuarioSAP":"SUREP012"},{"nombre":"RODRIGO","apellido":"MORALES","fullName":"RODRIGO MORALES","puesto":"Responsable","sucursalNombre":"FLORIDA","mail":"rmorales@isa.com.uy","usuarioSAP":"SURSP011"},{"nombre":"ANA","apellido":"SILVA","fullName":"ANA SILVA","puesto":"Aux. Admin","sucursalNombre":"FLORIDA","mail":"asilva@isa.com.uy","usuarioSAP":""}],"S012":[{"nombre":"MATEO","apellido":"RODRIGUEZ","fullName":"MATEO RODRIGUEZ","puesto":"Vendedor","sucursalNombre":"DURAZNO","mail":"mrodriguez@isa.com.uy","usuarioSAP":"SUREP013"},{"nombre":"PABLO","apellido":"PEREZ","fullName":"PABLO PEREZ","puesto":"Responsable","sucursalNombre":"DURAZNO","mail":"pperez@isa.com.uy","usuarioSAP":"SURSP012"}],"S013":[{"nombre":"SOFIA","apellido":"GONZALEZ","fullName":"SOFIA GONZALEZ","puesto":"Adm. Analisis","sucursalNombre":"MONTEVIDEO AGRO","mail":"sgonzalez2@isa.com.uy","usuarioSAP":""}],"S014":[{"nombre":"MARTIN","apellido":"SILVA","fullName":"MARTIN SILVA","puesto":"Vendedor","sucursalNombre":"OMBUES","mail":"msilva@isa.com.uy","usuarioSAP":"SUREP007"},{"nombre":"RAUL","apellido":"SOSA","fullName":"RAUL SOSA","puesto":"Responsable","sucursalNombre":"OMBUES","mail":"rsosa2@isa.com.uy","usuarioSAP":"SURSP014"}],"S015":[{"nombre":"Pablo","apellido":"Carballo","fullName":"Pablo Carballo","puesto":"Jfe Taller Cons","sucursalNombre":"MONTEVIDEO CONS","mail":"pcarballo@isa.com.uy","usuarioSAP":""},{"nombre":"GONZALO","apellido":"GOLDARACENA","fullName":"GONZALO GOLDARACENA","puesto":"Gerente","sucursalNombre":"MONTEVIDEO CONS","mail":"ggoldaracena@isa.com.uy","usuarioSAP":""},{"nombre":"MAURICIO","apellido":"LARRAÑAGA","fullName":"MAURICIO LARRAÑAGA","puesto":"Vendedor","sucursalNombre":"MONTEVIDEO CONS","mail":"mlarranaga@isa.com.uy","usuarioSAP":""},{"nombre":"MARIANA","apellido":"FERNANDEZ","fullName":"MARIANA FERNANDEZ","puesto":"Administr.","sucursalNombre":"MONTEVIDEO CONS","mail":"mfernandez@isa.com.uy","usuarioSAP":""}],"S016":[{"nombre":"GUSTAVO","apellido":"MIRANDA","fullName":"GUSTAVO MIRANDA","puesto":"Jefe Rep.","sucursalNombre":"MVDEO/SAN JOSE","mail":"gmiranda@isa.com.uy","usuarioSAP":"SUJRP001"}],"S017":[{"nombre":"NICOLAS","apellido":"PEREZ","fullName":"NICOLAS PEREZ","puesto":"Vendedor","sucursalNombre":"SAN CARLOS","mail":"nperez@isa.com.uy","usuarioSAP":"SUREP018"},{"nombre":"MARIO","apellido":"GOMEZ","fullName":"MARIO GOMEZ","puesto":"Responsable","sucursalNombre":"SAN CARLOS","mail":"mgomez@isa.com.uy","usuarioSAP":"SURSP017"}],"S018":[{"nombre":"SERGIO","apellido":"GONZALEZ","fullName":"SERGIO GONZALEZ","puesto":"Vendedor","sucursalNombre":"TACUAREMBO","mail":"segonzalez@isa.com.uy","usuarioSAP":"SUREP019"},{"nombre":"LUCIA","apellido":"MARTINEZ","fullName":"LUCIA MARTINEZ","puesto":"Aux Admin","sucursalNombre":"TACUAREMBO","mail":"lmartinez@isa.com.uy","usuarioSAP":""}],"S019":[{"nombre":"JULIO","apellido":"GONZALEZ","fullName":"JULIO GONZALEZ","puesto":"Vendedor","sucursalNombre":"SAN JOSE","mail":"jgonzalez@isa.com.uy","usuarioSAP":"SUREP003"},{"nombre":"SILVIA","apellido":"LOPEZ","fullName":"SILVIA LOPEZ","puesto":"Responsable","sucursalNombre":"SAN JOSE","mail":"slopez@isa.com.uy","usuarioSAP":"SURSP019"},{"nombre":"MARIA","apellido":"PEREIRA","fullName":"MARIA PEREIRA","puesto":"Administr.","sucursalNombre":"SAN JOSE","mail":"mpereira@isa.com.uy","usuarioSAP":""}]};

    const COMENTARIO_OPTS = ["Solicitar cotizacion","Stock en la red","Ticket reserva"];
    const RESPUESTA_OPTS  = ["Solicitar","No solicitar"];

    // ✅ UI helpers
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function showToast(text, isError=false){
      const el = $("toast");
      el.textContent = text;
      el.classList.toggle("err", isError);
      el.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => el.style.display = "none", 4200);
    }

    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function ensureDateIfRespuesta(row){
      if ((row.respuesta || "").trim() && !(row.fecha_respuesta || "").trim()){
        row.fecha_respuesta = todayISO();
      }
    }

    function fillSucursalSelect(sel, includeAll=false){
      const base = includeAll ? [`<option value="">(Todas)</option>`] : [`<option value="" selected>(Elegir)</option>`];
      sel.innerHTML = base.concat(SUCURSAL_OPTS.map(s => `<option value="${s}">${s}</option>`)).join("");
    }

    function fillDynamicSelect(sel, arr, includeAll=false){
      const base = includeAll ? [`<option value="">(Todas)</option>`] : [`<option value="" selected>(Elegir)</option>`];
      sel.innerHTML = base.concat((arr||[]).map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`)).join("");
    }

    function selectHTML(options, value, placeholder="(Elegir)"){
      const opts = [
        `<option value="">${escapeHtml(placeholder)}</option>`,
        ...options.map(o => `<option value="${escapeHtml(o)}" ${o===value ? "selected":""}>${escapeHtml(o)}</option>`)
      ];
      return opts.join("");
    }

    function renderPeoplePanel(centro){
      const el = $("peoplePanel");
      if(!centro){
        el.innerHTML = '<small>Seleccioná una sucursal para ver personas relacionadas.</small>';
        return;
      }
      const people = CENTRO_TO_PEOPLE[centro] || [];
      if(!people.length){
        el.innerHTML = `<small>No hay personas asociadas a ${escapeHtml(centro)}.</small>`;
        return;
      }
      const rows = people.map(p =>
        `<div style="padding:6px 8px;border-bottom:1px solid rgba(0,0,0,.04)">
          <b>${escapeHtml(p.fullName)}</b>
          ${p.puesto?('<span style="color:var(--muted)"> - '+escapeHtml(p.puesto)+'</span>'):''}
          <span style="color:var(--muted)">(${escapeHtml(p.sucursalNombre||"")})</span>
        </div>`
      ).join("");
      el.innerHTML = `<div style="font-weight:900;margin-bottom:6px">Personas en ${escapeHtml(centro)}</div>${rows}`;
    }

    // ============================================================
    // ✅ FIRESTORE DATA
    // ============================================================
    // Colección donde se guardan las filas:
    const COL = "solicitudes";

    let cache = [];   // [{id, data}]
    let view = [];
    let editingId = null;

    function matchesQ(row, q){
      if (!q) return true;
      q = q.trim().toLowerCase();
      const hay = [
        row.material,row.cantidad,row.solicitud,row.necesidad,row.sucursal,
        row.sucursalNombre,row.responsable,row.comentario,row.respuesta,row.fecha_respuesta
      ].map(v => String(v ?? "").toLowerCase()).join(" | ");
      return hay.includes(q);
    }

    function applyFilters(){
      const q = ($("q").value || "").trim();
      const fSucursal = $("fSucursal").value || "";
      const fComentario = $("fComentario").value || "";
      const fRespuesta  = $("fRespuesta").value || "";

      view = cache.filter(x => {
        const r = x.data;
        if (!matchesQ(r, q)) return false;
        if (fSucursal && (r.sucursal || "") !== fSucursal) return false;
        if (fComentario && (r.comentario || "") !== fComentario) return false;
        if (fRespuesta && (r.respuesta || "") !== fRespuesta) return false;
        return true;
      });

      draw();
    }

    ["q","fSucursal","fComentario","fRespuesta"].forEach(id=>{
      $(id).addEventListener("input", applyFilters);
      $(id).addEventListener("change", applyFilters);
    });

    $("clearFiltersBtn").addEventListener("click", ()=>{
      $("q").value = "";
      $("fSucursal").value = "";
      $("fComentario").value = "";
      $("fRespuesta").value = "";
      applyFilters();
    });

    function renderRow(id, r){
      const isEditing = (editingId === id);

      if (!isEditing){
        return `
          <tr data-id="${id}">
            <td><div class="cellInner">${escapeHtml(r.material)}</div></td>
            <td><div class="cellInner">${escapeHtml(r.cantidad)}</div></td>
            <td><div class="cellInner">${escapeHtml(r.solicitud)}</div></td>
            <td><div class="cellInner">${escapeHtml(r.necesidad)}</div></td>
            <td><div class="cellInner">${escapeHtml(r.sucursal || '')}</div></td>
            <td><div class="cellInner">${escapeHtml(r.sucursalNombre || '')}</div></td>
            <td><div class="cellInner">${escapeHtml(r.responsable || '')}</div></td>
            <td><div class="cellInner">${escapeHtml(r.comentario || '')}</div></td>
            <td><div class="cellInner">${escapeHtml(r.respuesta || '')}</div></td>
            <td><div class="cellInner">${escapeHtml(r.fecha_respuesta || '')}</div></td>
            <td>
              <div class="cellInner">
                <div class="actions">
                  <button class="small secondary" data-action="edit">✏️ Editar</button>
                </div>
              </div>
            </td>
          </tr>
        `;
      }

      const people = CENTRO_TO_PEOPLE[r.sucursal] || [];
      const fullNames = Array.from(new Set(people.map(p => p.fullName).filter(Boolean))).sort();

      return `
        <tr data-id="${id}">
          <td><div class="cellInner"><input class="cell-input w160" data-field="material" value="${escapeHtml(r.material)}"></div></td>
          <td><div class="cellInner"><input class="cell-input w140" data-field="cantidad" type="number" min="0" step="1" value="${escapeHtml(r.cantidad)}"></div></td>
          <td><div class="cellInner"><input class="cell-input w160" data-field="solicitud" value="${escapeHtml(r.solicitud)}"></div></td>
          <td><div class="cellInner"><input class="cell-input w160" data-field="necesidad" value="${escapeHtml(r.necesidad)}"></div></td>

          <td><div class="cellInner">
            <select class="cell-input w160" data-field="sucursal" data-role="editSucursal">
              ${selectHTML(SUCURSAL_OPTS, r.sucursal)}
            </select>
          </div></td>

          <td><div class="cellInner">
            <select class="cell-input w200" data-field="sucursalNombre">
              ${selectHTML(SUCURSAL_NOMBRE_OPTS, r.sucursalNombre)}
            </select>
          </div></td>

          <td><div class="cellInner">
            <select class="cell-input w220" data-role="editNombreSelect">
              ${selectHTML(fullNames, r.responsable || "")}
            </select>
          </div></td>

          <td><div class="cellInner">
            <select class="cell-input w200" data-field="comentario">
              ${selectHTML(COMENTARIO_OPTS, r.comentario || "")}
            </select>
          </div></td>

          <td><div class="cellInner">
            <select class="cell-input w160" data-field="respuesta" data-role="respuestaSelect">
              ${selectHTML(RESPUESTA_OPTS, r.respuesta || "")}
            </select>
          </div></td>

          <td><div class="cellInner">
            <input class="cell-input w160" data-field="fecha_respuesta" type="date" value="${escapeHtml(r.fecha_respuesta || "")}">
          </div></td>

          <td>
            <div class="cellInner">
              <div class="actions">
                <button class="small primary" data-action="save">Guardar</button>
                <button class="small" data-action="cancel">Cancelar</button>
                <button class="small danger" data-action="delete">Eliminar</button>
              </div>
            </div>
          </td>
        </tr>
      `;
    }

    function draw(){
      const tbody = $("tbody");
      const arr = (view.length ? view : cache);
      tbody.innerHTML = arr.map(x => renderRow(x.id, x.data)).join("");
    }

    // ✅ Agregar fila -> Firestore
    $("addBtn").addEventListener("click", async ()=>{
      const row = {
        material: $("a_material").value.trim(),
        cantidad: Number($("a_cantidad").value || 0),
        solicitud: $("a_solicitud").value.trim(),
        necesidad: $("a_necesidad").value.trim(),
        sucursal: $("a_sucursal").value || "",
        sucursalNombre: $("a_sucursal_nombre").value.trim(),
        responsable: ($("a_nombre").value || "").trim(),
        comentario: $("a_comentario").value || "",
        respuesta: $("a_respuesta").value || "",
        fecha_respuesta: $("a_fecha_respuesta").value || "",
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      if (!row.material){
        showToast("Material es obligatorio.", true);
        return;
      }

      ensureDateIfRespuesta(row);

      try{
        await addDoc(collection(db, COL), row);

        // limpiar
        $("a_material").value = "";
        $("a_cantidad").value = 1;
        $("a_solicitud").value = "";
        $("a_necesidad").value = "";
        $("a_sucursal").value = "";
        $("a_sucursal_nombre").value = "";
        $("a_nombre").value = "";
        $("a_responsable").value = "";
        $("a_comentario").value = "";
        $("a_respuesta").value = "";
        $("a_fecha_respuesta").value = "";

        showToast("Agregado con éxito");
        // onSnapshot se encarga de refrescar
      } catch(e){
        console.error(e);
        showToast("Error guardando en Firestore.", true);
        alert(e?.message || String(e));
      }
    });

    // ✅ Autocompletar fecha cuando cambia respuesta en edición
    $("tbody").addEventListener("change", (e)=>{
      const sel = e.target.closest('select[data-role="respuestaSelect"]');
      if (!sel) return;
      const tr = e.target.closest("tr[data-id]");
      if (!tr) return;
      const dateInput = tr.querySelector('input[data-field="fecha_respuesta"]');
      if (!dateInput) return;

      if (sel.value && !dateInput.value){
        dateInput.value = todayISO();
      }
    });

    // ✅ Acciones tabla -> update/delete Firestore
    $("tbody").addEventListener("click", async (e)=>{
      const btn = e.target.closest("[data-action]");
      if (!btn) return;

      const tr = e.target.closest("tr[data-id]");
      if (!tr) return;

      const id = tr.dataset.id;
      const action = btn.dataset.action;

      if (action === "edit"){ editingId = id; draw(); return; }
      if (action === "cancel"){ editingId = null; draw(); return; }

      if (action === "delete"){
        if (!confirm("¿Eliminar esta fila?")) return;
        try{
          await deleteDoc(doc(db, COL, id));
          if (editingId === id) editingId = null;
          showToast("Eliminado");
        }catch(err){
          console.error(err);
          showToast("Error eliminando.", true);
          alert(err?.message || String(err));
        }
        return;
      }

      if (action === "save"){
        const updated = {};
        const fields = tr.querySelectorAll("[data-field]");
        fields.forEach(el=>{
          const k = el.dataset.field;
          let v = el.value ?? "";
          if (k === "cantidad") v = Number(v || 0);
          updated[k] = (typeof v === "string") ? v.trim() : v;
        });

        const nombreSel = tr.querySelector('[data-role="editNombreSelect"]');
        updated.responsable = (nombreSel?.value || "").trim();

        ensureDateIfRespuesta(updated);
        updated.updatedAt = serverTimestamp();

        try{
          await updateDoc(doc(db, COL, id), updated);
          editingId = null;
          showToast("Guardado con éxito");
        }catch(err){
          console.error(err);
          showToast("Error guardando.", true);
          alert(err?.message || String(err));
        }
      }
    });

    // ✅ Cascada edición: cambia sucursal => filtra nombres y sugiere sucursalNombre
    $("tbody").addEventListener("change", (e)=>{
      const selSucursal = e.target.closest('select[data-role="editSucursal"]');
      if(!selSucursal) return;

      const tr = e.target.closest("tr[data-id]");
      if(!tr) return;

      const centro = selSucursal.value || "";
      const people = CENTRO_TO_PEOPLE[centro] || [];
      const fullNames = Array.from(new Set(people.map(p => p.fullName).filter(Boolean))).sort();

      const nombreSel = tr.querySelector('[data-role="editNombreSelect"]');
      if(nombreSel){
        fillDynamicSelect(nombreSel, fullNames, false);
        if(fullNames.length === 1) nombreSel.value = fullNames[0];
      }

      const sucNom = (people.find(p => p.sucursalNombre)?.sucursalNombre) || "";
      const sucNomSel = tr.querySelector('select[data-field="sucursalNombre"]');
      if(sucNomSel && sucNom) sucNomSel.value = sucNom;
    });

    // ✅ Export XLSX (desde Firestore)
    function exportXlsx(){
      const arr = (view.length ? view : cache).map(x => x.data);
      if (!arr.length){ alert("No hay datos para exportar."); return; }

      const rows = arr.map(r => ({
        "Material": r.material || "",
        "Cantidad": r.cantidad ?? "",
        "Solicitud": r.solicitud || "",
        "Necesidad": r.necesidad || "",
        "Centro": r.sucursal || "",
        "Sucursal": r.sucursalNombre || "",
        "Responsable": r.responsable || "",
        "Comentario": r.comentario || "",
        "Respuesta": r.respuesta || "",
        "Fecha de respuesta": r.fecha_respuesta || ""
      }));

      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Solicitudes");

      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const dd = String(now.getDate()).padStart(2,'0');
      XLSX.writeFile(wb, `solicitudes_${yyyy}-${mm}-${dd}.xlsx`);
    }
    $("exportXlsxBtn").addEventListener("click", exportXlsx);

    // ✅ Cascada agregar (Centro -> nombres + autocompleta sucursalNombre)
    function refreshAddNames(){
      const centro = $("a_sucursal").value || "";
      const people = CENTRO_TO_PEOPLE[centro] || [];
      const fullNames = Array.from(new Set(people.map(p => p.fullName).filter(Boolean))).sort();

      fillDynamicSelect($("a_nombre"), fullNames, false);
      if(fullNames.length === 1) $("a_nombre").value = fullNames[0];

      const sucNom = (people.find(p => p.sucursalNombre)?.sucursalNombre) || "";
      if(sucNom) $("a_sucursal_nombre").value = sucNom;

      $("a_responsable").value = ($("a_nombre").value || "").trim();
      renderPeoplePanel(centro);
    }
    $("a_sucursal").addEventListener("change", refreshAddNames);

    $("a_nombre").addEventListener("change", ()=>{
      $("a_responsable").value = ($("a_nombre").value || "").trim();
      const centro = $("a_sucursal").value || "";
      if(centro) renderPeoplePanel(centro);
    });

    // ✅ Cascada alternativa (Sucursal Nombre -> nombres + intenta setear centro si es único)
    $("a_sucursal_nombre").addEventListener("change", ()=>{
      const sucNom = ($("a_sucursal_nombre").value || "").trim();
      if(!sucNom){
        $("a_sucursal").value = "";
        fillDynamicSelect($("a_nombre"), [], false);
        $("a_responsable").value = "";
        renderPeoplePanel("");
        return;
      }

      const people = [];
      const centros = new Set();
      Object.entries(CENTRO_TO_PEOPLE).forEach(([centro, list])=>{
        list.forEach(p=>{
          if((p.sucursalNombre||"").trim().toUpperCase() === sucNom.toUpperCase()){
            people.push(p);
            centros.add(centro);
          }
        });
      });

      const fullNames = Array.from(new Set(people.map(p => p.fullName).filter(Boolean))).sort();
      fillDynamicSelect($("a_nombre"), fullNames, false);
      if(fullNames.length === 1) $("a_nombre").value = fullNames[0];

      const centroList = Array.from(centros);
      $("a_sucursal").value = (centroList.length === 1) ? centroList[0] : "";

      $("a_responsable").value = ($("a_nombre").value || "").trim();
      if($("a_sucursal").value) renderPeoplePanel($("a_sucursal").value);
    });

    // ============================================================
    // ✅ Firestore realtime listener
    // ============================================================
    const qSnap = query(collection(db, COL), orderBy("createdAt", "desc"));
    onSnapshot(qSnap, (snap)=>{
      cache = [];
      snap.forEach(d => cache.push({ id: d.id, data: d.data() }));
      applyFilters();
    }, (err)=>{
      console.error(err);
      showToast("No se pudo leer Firestore.", true);
    });

    // Init selects + table
    fillSucursalSelect($("fSucursal"), true);
    fillDynamicSelect($("a_sucursal"), CENTRO_OPTS, false);
    fillDynamicSelect($("a_sucursal_nombre"), SUCURSAL_NOMBRE_OPTS, false);
    fillDynamicSelect($("a_nombre"), [], false);
    applyFilters();
  </script>
</body>
</html>
