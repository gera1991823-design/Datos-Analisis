<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Carga de datos - Interagrovial</title>

  <!-- ✅ XLSX (SheetJS) para exportar a Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --jd-green:#367c2b;
      --jd-yellow:#ffde00;

      --bg:#f6f7fb;
      --text:#071218;
      --title-color:#000;
      --row-text:#3b4950;
      --muted:#5b646d;

      --border:#e6e9ef;
      --border-strong:#c9d2d9;

      --shadow:0 12px 30px rgba(15,23,32,.06);
      --shadow2:0 6px 14px rgba(15,23,32,.04);
      --radius:16px;
    }

    *{box-sizing:border-box}
    html {
      scrollbar-gutter: stable;
    }
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 22px;
      background: radial-gradient(1200px 600px at 15% 0%, rgba(54,124,43,.06), transparent 55%),
                  radial-gradient(1200px 600px at 85% 0%, rgba(255,222,0,.03), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:14px;flex-wrap:wrap;margin-bottom:14px;
    }
    .title{
      display:flex;align-items:center;gap:12px;margin:0;
      font-size:22px;font-weight:900;letter-spacing:.2px;
      color: #000000 !important;
    }
    .brandDot{
      width:14px;height:14px;border-radius:999px;
      background: var(--jd-green);
      box-shadow: inset 0 0 0 3px var(--jd-yellow);
    }
    .subpill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--border);
      padding:8px 12px;border-radius:999px;
      background: rgba(0,0,0,.03);
      font-size:12px;color:var(--muted);
      box-shadow: var(--shadow2);
    }
    .subpill b{color:var(--jd-green)}

    .card{
      background: linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.01));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 14px;
      overflow:hidden;
    }
    .accentBar{display:none;}
    .cardHeader{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;flex-wrap:wrap;margin-bottom:10px;
    }
    .card h3{
      margin:6px 0 12px;font-size:20px;
      text-transform:uppercase;letter-spacing:.08em;
      color:#000000 !important;
      font-weight:900 !important;
      display:inline-block;
      background: rgba(255,255,255,0.98);
      padding:8px 12px;border-radius:8px;border:1px solid var(--border);
    }
    .cardHeader{border-bottom:1px solid var(--border);padding-bottom:14px;margin-bottom:18px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px;font-weight:800}

    input,select{
      padding:10px 12px;
      border:1px solid var(--border-strong);
      border-radius:14px;
      font-size:14px;
      font-family: inherit;
      min-width:160px;
      background: rgba(0,0,0,.04);
      color: var(--text);
      outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.03);
      height: auto;
      line-height: 1.4;
    }
    input::placeholder{color:var(--muted)}
    input:focus,select:focus{
      border-color: rgba(54,124,43,.85);
      box-shadow: 0 0 0 4px rgba(54,124,43,.20);
    }
    input[type="date"]{min-width:170px;color-scheme:dark}

    button{
      padding:10px 12px;border:1px solid var(--border-strong);
      background: rgba(0,0,0,.04);
      border-radius:14px;cursor:pointer;
      transition:.12s ease;font-weight:900;color:var(--text);
      box-shadow: var(--shadow2);
    }
    button:hover{transform: translateY(-1px)}
    button.primary{
      background: rgba(54,124,43,.85);
      border-color: rgba(54,124,43,.85);
      color:#fff;
      box-shadow: 0 12px 22px rgba(54,124,43,.18);
    }
    button.secondary{
      border-color: rgba(54,124,43,.55);
      color:#d9f1d3;
      background: rgba(54,124,43,.12);
    }
    button.danger{
      color:#ffd7dc;border-color:#5a2731;background: rgba(176,0,32,.16);
    }
    button.small{
      padding:6px 10px;
      border-radius:8px;
      font-size:11px;
      box-shadow:none;
      font-weight:700;
      flex: 1 1 auto;
      white-space:nowrap;
      min-width: auto;
      max-width: none;
    }
    button[disabled]{opacity:.6;cursor:not-allowed;transform:none}

    .muted{color:var(--muted);font-size:12px;margin-top:8px}
    .toast{margin-top:10px;font-size:13px;color:#2f7e2c;display:none;font-weight:900}
    .toast.err{color:#ff2d2d}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 14px;
      background: transparent;
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:visible;
      box-shadow: var(--shadow);
    }
    thead th{
      background: rgba(0,0,0,.03);
      position:sticky;top:0;z-index:2;
      text-align:center;
    }
    th,td{
      border-bottom: none;
      padding:0;font-size:14px;vertical-align:middle;
      white-space:nowrap;text-align:center;color:var(--text);
      font-weight:600;
      background-clip: padding-box;
    }

    .cellInner{
      display:flex;align-items:center;justify-content:center;
      padding:14px 10px;border-radius:10px;
      height:48px;
      width:100%;box-sizing:border-box;
      font-weight:600;
      color: var(--row-text);
      border:1px solid rgba(15,23,32,.04);
      box-shadow: 0 10px 18px rgba(15,23,32,.06);
    }
    
    /* Celda de acciones mantiene altura fija */
    td:last-child .cellInner {
      height: 48px;
      flex-wrap: wrap;
      align-content: center;
      padding: 4px 2px;
      overflow: hidden;
    }
    tbody tr:nth-child(odd) .cellInner{background: #e3eaee}
    tbody tr:nth-child(even) .cellInner{background: #d3dde2}
    tbody tr:hover .cellInner{background: rgba(54,124,43,.12)}
    .cellInner .cell-input{
      width:100%;
      box-sizing:border-box;
      background:transparent;
      border:none;
      padding:0 7px;
      height: 100%;
      max-height: 48px;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      margin: 0;
    }
    
    .cellInner input.cell-input,
    .cellInner select.cell-input {
      padding: 4px 7px;
      height: 48px;
      max-height: 48px;
      line-height: 1.4;
    }

    th{
      font-size:13px;letter-spacing:.06em;text-transform:uppercase;
      color:var(--muted);position:relative;padding:12px 8px;
    }
    th::after{display:none}

    tbody tr:nth-child(odd){background: #f3f6f8}
    tbody tr:nth-child(even){background: #e9eef2}
    tbody tr{transition: background .12s ease}
    tbody tr:hover{background: rgba(54,124,43,.09)}
    tbody tr{box-shadow: 0 8px 20px rgba(15,23,32,.06);border-radius:10px}
    tbody tr td{background:transparent}

    .actions{
      display:flex;
      gap:4px;
      flex-wrap:nowrap;
      justify-content:center;
      width: 100%;
    }
    
    /* Columna de acciones con ancho moderado */
    td:last-child {
      min-width: 120px;
    }
    
    td:last-child .cellInner {
      padding: 4px 2px;
      justify-content:center;
    }
    
    .cell-input{
      min-width:120px;
      padding:7px 10px;
      border-radius:12px;
      border:1px solid var(--border-strong);
      background: rgba(255,255,255,.03);
      color: var(--text);
      text-align:center;
      height: auto;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      line-height: 1.4;
    }

    .w220{min-width:220px}
    .w200{min-width:200px}
    .w160{min-width:160px}
    .w140{min-width:140px}
    .w110{min-width:110px}

    .footer{
      position:fixed;left:16px;bottom:12px;font-size:12px;
      color:var(--text);background: rgba(255,255,255,.98);
      border:1px solid var(--border);
      border-left:7px solid var(--jd-green);
      padding:9px 12px;border-radius:14px;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(6px);
    }
    .footer b{color:var(--jd-green)}

    .attLinks{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center}
    a{color:var(--jd-green);font-weight:700}
    .pillX{
      display:inline-flex;align-items:center;justify-content:center;
      width:22px;height:22px;border-radius:999px;
      border:1px solid rgba(161,0,26,.16);
      background: rgba(161,0,26,.12);
      color:#7f0014;font-weight:900;
      cursor:pointer;
    }

    button.small.secondary{
      border-color: rgba(54,124,43,.85);
      color: #fff;
      background: rgba(54,124,43,.75);
      box-shadow: 0 6px 12px rgba(54,124,43,.15);
      font-weight: 700;
      padding: 6px 12px;
    }
    button.small.secondary:hover{
      background: rgba(54,124,43,.90);
    }
    button.small.primary{box-shadow: 0 10px 18px rgba(54,124,43,.10)}
    .actions button{color:#000 !important; font-weight:700}

    .row-add{
      display:flex;
      flex-wrap: wrap;
      gap:10px;
      align-items:flex-end;
    }
    .row-add > div{flex:0 1 auto; min-width:0;}
    .row-add input, .row-add select{min-width:120px;}
    .row-add .w200{min-width:160px}
    .row-add .w140{min-width:120px}
    .row-add input[type="date"]{min-width:140px}

    @media (max-width: 1200px){
      .row-add > div{flex: 1 1 210px;}
      .row-add button#addBtn{flex: 0 0 auto;}
    }

    /* =========================
       ✅ AVISO GRANDE ARRIBO
    ========================= */
    .arrivalNotice{
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 9999;
      display: none;
      width: min(460px, calc(100vw - 32px));
      border-radius: 18px;
      background: #ffffff;
      border: 3px solid var(--jd-green);
      box-shadow: 0 18px 50px rgba(0,0,0,.22);
      overflow: hidden;
      animation: popIn .18s ease-out;
    }
    @keyframes popIn{
      from{ transform: translateY(-6px); opacity: .7; }
      to{ transform: translateY(0px); opacity: 1; }
    }
    .arrivalHeader{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 14px;
      background: linear-gradient(90deg, rgba(54,124,43,.95), rgba(54,124,43,.82));
      color:#fff;
      font-weight:900;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .arrivalHeader img{
      width:36px;height:36px;
      border-radius:12px;
      background:#fff;
      padding:4px;
      object-fit:contain;
    }
    .arrivalBody{
      padding:12px 14px 14px;
      border-top: 6px solid var(--jd-yellow);
      color: #071218;
    }
    .arrivalTitle{
      font-size:16px;
      font-weight:900;
      margin:0 0 8px;
    }
    .arrivalBody p{
      margin: 5px 0;
      font-size: 14px;
      line-height: 1.25;
    }
    .arrivalBody b{
      font-weight: 900;
      color: #000;
    }
    .arrivalActions{
      margin-top: 10px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .arrivalActions button{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border-strong);
      cursor:pointer;
      font-weight:900;
      background: rgba(0,0,0,.04);
    }
    .arrivalActions button.primary{
      background: rgba(54,124,43,.92);
      border-color: rgba(54,124,43,.92);
      color: white;
    }

    /* =========================
       ✅ CENTRO DE NOTIFICACIONES (campana)
    ========================= */
    .notifWrap{ position:relative; }
    .notifBell{
      position:relative;
      min-width:auto;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border-strong);
      background: rgba(0,0,0,.04);
      font-weight:900;
      box-shadow: var(--shadow2);
      cursor:pointer;
    }
    .notifBadge{
      position:absolute;
      top:-6px;
      right:-6px;
      background: var(--jd-yellow);
      color:#000;
      border:2px solid var(--jd-green);
      min-width:22px;
      height:22px;
      padding:0 6px;
      border-radius:999px;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      box-shadow: var(--shadow2);
    }
    .notifPanel{
      position:absolute;
      top:52px;
      right:0;
      width:min(420px, calc(100vw - 32px));
      max-height:70vh;
      overflow:auto;
      background:#fff;
      border:2px solid var(--jd-green);
      border-radius:16px;
      box-shadow: 0 18px 50px rgba(0,0,0,.18);
      z-index: 9998;
    }
    .notifHeader{
      position:sticky;
      top:0;
      background: linear-gradient(90deg, rgba(54,124,43,.95), rgba(54,124,43,.85));
      border-bottom:2px solid var(--jd-green);
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: #fff;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .06em;
      font-size: 13px;
    }
    .notifActions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .notifItem{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      gap:12px;
      align-items:flex-start;
      transition: all .12s ease;
      position: relative;
    }
    .notifItem:last-child{
      border-bottom: none;
    }
    .notifDot{
      width:12px; height:12px; border-radius:999px;
      background: var(--jd-green);
      box-shadow: 0 0 0 4px var(--jd-yellow);
      margin-top:4px;
      flex:0 0 auto;
    }
    .notifMain{ flex:1 1 auto; min-width:0; }
    .notifMain .t{
      font-weight:900;
      color:#000;
      margin:0 0 6px;
      font-size: 14px;
      letter-spacing: .02em;
    }
    .notifMain .d{
      margin:0;
      color: var(--row-text);
      font-size:13px;
      line-height:1.4;
      font-weight: 600;
    }
    .notifMain .meta{
      margin-top:8px;
      font-size:12px;
      color: var(--muted);
      font-weight:700;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .notifItem.unread{
      background: linear-gradient(90deg, rgba(54,124,43,.15) 0%, rgba(54,124,43,.06) 100%);
      border-left: 5px solid var(--jd-green);
      padding-left: 11px;
    }
    .notifItem.unread .notifDot{
      animation: pulse 2s ease-in-out infinite;
    }
    .notifItem.read{
      background: rgba(0,0,0,.02);
      opacity: 0.85;
    }
    .notifCheckmark{
      display: inline-block;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--jd-green);
      color: #fff;
      font-weight: 900;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    /* Botones específicos del panel de notificaciones */
    #notifMarkReadBtn{
      border-color: #22a14c !important;
      background: linear-gradient(135deg, #2ecc71, #27ae60) !important;
      color: #fff !important;
      font-weight: 900 !important;
      box-shadow: 0 6px 16px rgba(46,204,113,.25) !important;
    }
    #notifMarkReadBtn:hover{
      background: linear-gradient(135deg, #27ae60, #229954) !important;
    }
    
    #notifMarkUnreadBtn{
      border-color: #e74c3c !important;
      background: linear-gradient(135deg, #e67e22, #d35400) !important;
      color: #fff !important;
      font-weight: 900 !important;
      box-shadow: 0 6px 16px rgba(230,126,34,.25) !important;
    }
    #notifMarkUnreadBtn:hover{
      background: linear-gradient(135deg, #d35400, #ba4a00) !important;
    }
    
    #notifCloseBtn{
      border-color: #95a5a6 !important;
      background: linear-gradient(135deg, #bdc3c7, #95a5a6) !important;
      color: #fff !important;
      font-weight: 900 !important;
      box-shadow: 0 6px 16px rgba(149,165,166,.15) !important;
    }
    #notifCloseBtn:hover{
      background: linear-gradient(135deg, #95a5a6, #7f8c8d) !important;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ✅ Resaltado al ir a una fila desde notificaciones */
    tr.rowHighlight .cellInner{
      border: 2px solid var(--jd-yellow) !important;
      box-shadow: 0 0 0 4px rgba(255,222,0,.35), 0 14px 22px rgba(15,23,32,.12) !important;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <h1 class="title"><span class="brandDot"></span> Carga de datos</h1>

    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
      <div class="subpill">Estilo <b>Interagrovial</b> · verde/amarillo</div>

      <!-- ✅ Campana notificaciones -->
      <div class="notifWrap">
        <button id="notifBell" class="notifBell" type="button" title="Notificaciones">
          🔔
          <span id="notifBadge" class="notifBadge" style="display:none;">0</span>
        </button>

        <div id="notifPanel" class="notifPanel" style="display:none;">
          <div class="notifHeader">
            <div><b>Notificaciones</b></div>
            <div class="notifActions">
              <button id="notifFilterUnread" class="small secondary" type="button" style="background: linear-gradient(135deg, #e67e22, #d35400) !important;">No leídas</button>
              <button id="notifFilterRead" class="small secondary" type="button">Leídas</button>
              <button id="notifCloseBtn" class="small" type="button">Cerrar</button>
            </div>
          </div>

          <div id="notifList">
            <div class="muted" style="padding:16px; text-align:center; font-size:14px;">Sin notificaciones por el momento</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ AVISO GRANDE ARRIBO/LLEGADA -->
  <div id="arrivalNotice" class="arrivalNotice">
    <div class="arrivalHeader">
      <img id="arrivalLogo" alt="Logo John Deere">
      <div>ARRIBO / LLEGADA</div>
    </div>
    <div class="arrivalBody">
      <p class="arrivalTitle"><b id="arrivalTitle">✅ ARRIBO / LLEGADA CONFIRMADA</b></p>
      <p id="arrivalLine1"></p>
      <p id="arrivalLine2"></p>
      <p id="arrivalLine3"></p>

      <div class="arrivalActions">
        <button id="arrivalCloseBtn">Cerrar</button>
        <button id="arrivalOkBtn" class="primary">OK</button>
      </div>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="card">
    <div class="accentBar"></div>
    <div class="cardHeader">
      <h3>Filtros</h3>
      <div class="row" style="gap:8px">
        <button id="clearFiltersBtn" class="secondary" type="button">Limpiar filtros</button>
        <button id="exportXlsxBtn" class="secondary" type="button">Descargar XLSX</button>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Buscar (cualquier campo)</label>
        <input id="q" class="w220" placeholder="Ej: 12004566 / AGRO / 88855 / VACIO"/>
      </div>

      <div>
        <label>Orden de compra</label>
        <input id="fOC" class="w160" placeholder="Ej: 12004566 o VACIO"/>
      </div>

      <div>
        <label>División</label>
        <select id="fDivision">
          <option value="">(Todas)</option>
        </select>
      </div>

      <div>
        <label>Condiciones</label>
        <select id="fCond">
          <option value="">(Todas)</option>
          <option value="__EMPTY__">(Vacío)</option>
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label>WIS</label>
        <select id="fWis">
          <option value="">(Todas)</option>
          <option value="__EMPTY__">(Vacío)</option>
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label>Cierre de carpeta</label>
        <select id="fCierre">
          <option value="">(Todas)</option>
          <option value="__EMPTY__">(Vacío)</option>
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label>Confirmación de llegada</label>
        <select id="fConfirmacionLlegada">
          <option value="">(Todas)</option>
          <option value="__EMPTY__">(Vacío)</option>
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label>Fecha estimada UY</label>
        <select id="fFechaMode">
          <option value="">(Todas)</option>
          <option value="CON">Con fecha</option>
          <option value="VACIO">Vacío</option>
        </select>
      </div>

      <div>
        <label>Fecha estimada UY desde</label>
        <input id="fDateFrom" type="date"/>
      </div>

      <div>
        <label>Fecha estimada UY hasta</label>
        <input id="fDateTo" type="date"/>
      </div>
    </div>

    <div class="muted">Los filtros se aplican automáticamente sobre la tabla. Escribí <b>VACIO</b> para ver campos sin datos.</div>
  </div>

  <!-- FORMULARIO AGREGAR -->
  <div class="card">
    <div class="accentBar"></div>
    <h3>Agregar fila</h3>

    <div class="row row-add">
      <div>
        <label>Factura</label>
        <input id="factura" class="w140" inputmode="numeric" placeholder="Ej: 456222"/>
      </div>

      <div>
        <label>División</label>
        <input id="division" class="w200" placeholder="Ej: AGRO"/>
      </div>

      <div>
        <label>Transporte</label>
        <input id="transporte" class="w200" placeholder="Ej: Barco / Avión"/>
      </div>

      <div>
        <label>Carpeta</label>
        <input id="carpeta" class="w140" placeholder="Ej: 88855"/>
      </div>

      <div>
        <label>DUA</label>
        <input id="dua" class="w140" placeholder="Ej: 123456"/>
      </div>

      <div>
        <label>Fecha estimada UY</label>
        <input id="fecha_estimada" type="date" />
      </div>

      <div>
        <label>Fecha depósito</label>
        <input id="fecha_deposito" type="date" />
      </div>

      <div>
        <label>Orden de compra</label>
        <input id="oc" class="w140" inputmode="numeric" placeholder="Ej: 12004566"/>
      </div>

      <div>
        <label>Cierre de carpeta</label>
        <select id="cierre">
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label>Condiciones</label>
        <select id="cond">
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label>WIS</label>
        <select id="wis">
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label>Confirmación de llegada</label>
        <select id="confirmacion_llegada">
          <option value="SI">SI</option>
          <option value="NO" selected>NO</option>
        </select>
      </div>

      <button id="addBtn" class="primary" type="button">Agregar</button>
    </div>

    <div id="msg" class="muted"></div>
    <div id="toast" class="toast"></div>
  </div>

  <!-- pickers ocultos -->
  <input
    id="packingRowPicker"
    type="file"
    accept=".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    style="display:none"
  />
  <input
    id="attRowPicker"
    type="file"
    multiple
    style="display:none"
  />

  <!-- TABLA -->
  <table>
    <thead>
      <tr>
        <th>Fecha carga</th>
        <th>Factura</th>
        <th>División</th>
        <th>Transporte</th>
        <th>Carpeta</th>
        <th>DUA</th>
        <th>Fecha estimada UY</th>
        <th>Orden compra</th>

        <th>Cierre carpeta</th>
        <th>Condiciones</th>
        <th>WIS</th>

        <th>Fecha depósito</th>
        <th>Confirmación de llegada</th>

        <th>Packing</th>
        <th>Adjuntos</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="footer"><b>INTERAGROVIAL S.A</b></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
      serverTimestamp, query, orderBy, onSnapshot,
      getDoc, setDoc, writeBatch, limit
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import {
      getStorage, ref as sRef, uploadBytesResumable, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDIGkNekvGn0XrqGvDAuutCBSglod03644",
      authDomain: "carpetas-17846.firebaseapp.com",
      projectId: "carpetas-17846",
      storageBucket: "carpetas-17846.firebasestorage.app",
      messagingSenderId: "513234224676",
      appId: "1:513234224676:web:a61b7ab9685594d1b5bab1",
      measurementId: "G-8Z18FTM0L6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const $ = (id) => document.getElementById(id);
    const tbody = $("tbody");
    const msgEl = $("msg");
    const toastEl = $("toast");
    const addBtn = $("addBtn");

    // ✅ John Deere logo
    const JD_LOGO_URL = "https://upload.wikimedia.org/wikipedia/commons/thumb/8/8d/John_Deere_logo.svg/320px-John_Deere_logo.svg.png";

    // ✅ ARRIBO/LLEGADA UI (aviso grande)
    const arrivalNotice = $("arrivalNotice");
    const arrivalLogo = $("arrivalLogo");
    const arrivalTitle = $("arrivalTitle");
    const arrivalLine1 = $("arrivalLine1");
    const arrivalLine2 = $("arrivalLine2");
    const arrivalLine3 = $("arrivalLine3");
    const arrivalCloseBtn = $("arrivalCloseBtn");
    const arrivalOkBtn = $("arrivalOkBtn");
    arrivalLogo.src = JD_LOGO_URL;

    // ✅ Centro de notificaciones UI
    const notifBell = $("notifBell");
    const notifBadge = $("notifBadge");
    const notifPanel = $("notifPanel");
    const notifList = $("notifList");
    const notifCloseBtn = $("notifCloseBtn");
    const notifFilterUnread = $("notifFilterUnread");
    const notifFilterRead = $("notifFilterRead");
    
    let notifFilterMode = "unread"; // "unread" o "read"

    let editingRowId = null;
    let cache = [];
    let view = [];

    let pendingPackingRowId = null;
    let pendingAttRowId = null;

    function showToast(text, isError=false){
      toastEl.textContent = text;
      toastEl.classList.toggle("err", isError);
      toastEl.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toastEl.style.display = "none", 4500);
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function formatDateVal(v){
      if (!v) return "";
      if (v instanceof Date){
        const dd = String(v.getDate()).padStart(2,'0');
        const mm = String(v.getMonth()+1).padStart(2,'0');
        const yyyy = v.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      }
      const m = String(v).match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return `${m[3]}/${m[2]}/${m[1]}`;
      const d = new Date(v);
      if (!isNaN(d)){
        return formatDateVal(d);
      }
      return String(v);
    }

    function errText(e){
      const code = e?.code ? `[${e.code}] ` : "";
      const msg = e?.message || String(e);
      return code + msg;
    }

    function safeYesNo(v){ return (v === "NO") ? "NO" : "SI"; }
    function uid(){ return (crypto?.randomUUID ? crypto.randomUUID() : `${Date.now()}_${Math.random().toString(16).slice(2)}`); }
    function norm(s){ return (s ?? "").toString().trim().toLowerCase(); }
    function isEmptyVal(v){ return v == null || String(v).trim() === ""; }

    function isExcelFile(file){
      if (!file) return false;
      const name = (file.name || "").toLowerCase();
      return name.endsWith(".xls") || name.endsWith(".xlsx");
    }

    function clearAddForm() {
      $("factura").value = "";
      $("division").value = "";
      $("transporte").value = "";
      $("carpeta").value = "";
      $("dua").value = "";
      $("fecha_estimada").value = "";
      $("fecha_deposito").value = "";
      $("oc").value = "";
      $("cierre").value = "SI";
      $("cond").value = "SI";
      $("wis").value = "SI";
      $("confirmacion_llegada").value = "NO";
    }

    // =========================
    // ✅ ARRIBO: aviso grande
    // =========================
    function showArrivalNotice(data){
      const oc = data.oc || "";
      const carpeta = data.carpeta || "";
      const factura = data.factura || "";
      const transporte = data.transporte || "";
      const division = data.division || "";

      arrivalTitle.textContent = "✅ ARRIBO / LLEGADA CONFIRMADA";
      arrivalLine1.innerHTML = `<b>Orden de compra:</b> ${escapeHtml(oc || "—")}  ·  <b>Carpeta:</b> ${escapeHtml(carpeta || "—")}`;
      arrivalLine2.innerHTML = `<b>Factura:</b> ${escapeHtml(factura || "—")}  ·  <b>División:</b> ${escapeHtml(division || "—")}`;
      arrivalLine3.innerHTML = `<b>Transporte:</b> ${escapeHtml(transporte || "—")}`;

      arrivalNotice.style.display = "block";
      clearTimeout(showArrivalNotice._t);
      showArrivalNotice._t = setTimeout(() => arrivalNotice.style.display = "none", 12000);
    }
    arrivalCloseBtn.addEventListener("click", ()=> arrivalNotice.style.display = "none");
    arrivalOkBtn.addEventListener("click", ()=> arrivalNotice.style.display = "none");

    // =========================
    // ✅ Sonido + Notification API
    // =========================
    function beep(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.frequency.value = 880;
        g.gain.value = 0.05;
        o.start();
        setTimeout(()=>{ o.stop(); ctx.close(); }, 220);
      } catch(_) {}
    }

    async function browserNotifyArribo(data){
      try{
        if (!("Notification" in window)) return;

        if (Notification.permission === "default") {
          await Notification.requestPermission();
        }
        if (Notification.permission !== "granted") return;

        const oc = data.oc || "";
        const carpeta = data.carpeta || "";
        const factura = data.factura || "";

        new Notification("🚜 ARRIBO / LLEGADA CONFIRMADA", {
          body: `OC: ${oc} | Carpeta: ${carpeta} | Factura: ${factura}`,
          icon: JD_LOGO_URL,
          tag: "arribo-llegada",
          requireInteraction: true
        });
      } catch(_) {}
    }

    // ✅ Parpadeo del título si estás fuera de la pestaña
    let originalTitle = document.title;
    let titleBlinkTimer = null;

    function startTitleBlink(){
      stopTitleBlink();
      let on = false;
      titleBlinkTimer = setInterval(() => {
        document.title = on ? "🚜 ARRIBO CONFIRMADO" : originalTitle;
        on = !on;
      }, 900);
      setTimeout(stopTitleBlink, 15000);
    }

    function stopTitleBlink(){
      if (titleBlinkTimer){
        clearInterval(titleBlinkTimer);
        titleBlinkTimer = null;
      }
      document.title = originalTitle;
    }

    document.addEventListener("visibilitychange", () => {
      if (!document.hidden) stopTitleBlink();
    });

    // =========================
    // ✅ NOTIFICACIONES en Firestore (campana)
    // Colección: notifications
    // =========================
    function fmtTS(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : null;
        if (!d) return "";
        return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      } catch { return ""; }
    }

    async function createNotificationForArrival(rowId, rowData){
      try{
        // Solo crear notificación por carpeta, no por fila individual
        const carpeta = (rowData.carpeta || "").toString().trim();
        if (!carpeta) return; // No notificar si no hay carpeta
        
        // Verificar si ya existe una notificación no leída para esta carpeta
        const existingForCarpeta = notificationsCache.find(n => 
          (n.data.carpeta || "").toString().trim() === carpeta &&
          n.data.read !== true
        );
        
        // Si ya existe una notificación no leída para esta carpeta, no crear otra
        if (existingForCarpeta) return;
        
        const payload = {
          type: "ARRIBO",
          title: `ARRIBO / LLEGADA CONFIRMADA - Carpeta ${carpeta}`,
          rowId,
          carpeta: carpeta,
          oc: rowData.oc || "",
          factura: rowData.factura || "",
          division: rowData.division || "",
          transporte: rowData.transporte || "",
          read: false,
          createdAt: serverTimestamp()
        };
        await addDoc(collection(db, "notifications"), payload);
      } catch (e){
        console.warn("No se pudo crear notificación global:", e);
      }
    }

    // UI: abrir/cerrar panel
    notifBell.addEventListener("click", ()=>{
      notifPanel.style.display = (notifPanel.style.display === "none") ? "block" : "none";
    });
    notifCloseBtn.addEventListener("click", ()=> notifPanel.style.display = "none");

    // Filtrar por notificaciones no leídas
    notifFilterUnread.addEventListener("click", () => {
      notifFilterMode = "unread";
      notifFilterUnread.style.background = "linear-gradient(135deg, #e67e22, #d35400) !important";
      notifFilterUnread.style.color = "#fff";
      notifFilterRead.style.background = "rgba(54,124,43,.75)";
      notifFilterRead.style.color = "#fff";
      renderNotif();
    });

    // Filtrar por notificaciones leídas
    notifFilterRead.addEventListener("click", () => {
      notifFilterMode = "read";
      notifFilterRead.style.background = "linear-gradient(135deg, #2ecc71, #27ae60) !important";
      notifFilterRead.style.color = "#fff";
      notifFilterUnread.style.background = "rgba(54,124,43,.75)";
      notifFilterUnread.style.color = "#fff";
      renderNotif();
    });

    // Cerrar panel al click afuera
    document.addEventListener("click", (e)=>{
      if (!notifPanel || notifPanel.style.display === "none") return;
      const wrap = e.target.closest(".notifWrap");
      if (!wrap) notifPanel.style.display = "none";
    });

    // Cache + render
    let notificationsCache = []; // {id,data}
    function renderNotif(){
      const unread = notificationsCache.filter(n => n.data.read !== true).length;
      if (unread > 0){
        notifBadge.style.display = "inline-flex";
        notifBadge.textContent = String(unread);
      } else {
        notifBadge.style.display = "none";
      }

      // Filtrar según el modo seleccionado
      let toDisplay = notificationsCache;
      if (notifFilterMode === "unread") {
        toDisplay = notificationsCache.filter(n => n.data.read !== true);
      } else if (notifFilterMode === "read") {
        toDisplay = notificationsCache.filter(n => n.data.read === true);
      }

      if (!toDisplay.length){
        const msg = notifFilterMode === "unread" ? 
          "Sin notificaciones no leídas" : 
          "Sin notificaciones leídas";
        notifList.innerHTML = `<div class="muted" style="padding:16px; text-align:center; font-size:14px;">${msg}</div>`;
        return;
      }

      // Agrupar por carpeta
      const grouped = {};
      toDisplay.forEach(n => {
        const carpeta = (n.data.carpeta || "sin-carpeta").toString().trim();
        if (!grouped[carpeta]) {
          grouped[carpeta] = [];
        }
        grouped[carpeta].push(n);
      });

      // Ordenar grupos por fecha más reciente (descendente)
      const sortedGroups = Object.entries(grouped).sort((a, b) => {
        const latestA = a[1][0]?.data?.createdAt;
        const latestB = b[1][0]?.data?.createdAt;
        
        // Convertir timestamps de Firestore a milisegundos para comparar
        const timeA = latestA?.toMillis ? latestA.toMillis() : 0;
        const timeB = latestB?.toMillis ? latestB.toMillis() : 0;
        
        return timeB - timeA; // Más recientes primero
      });

      // Renderizar notificaciones agrupadas
      const notifsByGroup = sortedGroups.map(([carpeta, items]) => {
        // Tomar la notificación más reciente del grupo
        const latest = items[0]; // Ya están ordenadas por createdAt desc
        const d = latest.data || {};
        const isUnread = d.read !== true;
        const meta = fmtTS(d.createdAt);
        const count = items.length > 1 ? ` (${items.length} filas)` : "";
        const checkmark = isUnread ? "🔔" : "✓";
        
        return `
          <div class="notifItem ${isUnread ? "unread" : "read"}" data-carpeta="${escapeHtml(carpeta)}">
            <div class="notifDot"></div>
            <div class="notifMain">
              <div class="t">📦 Carpeta ${escapeHtml(carpeta)}${count}</div>
              <div class="d">
                <span>🏭 OC: <b>${escapeHtml(d.oc || "—")}</b></span><br>
                <span>📄 Factura: <b>${escapeHtml(d.factura || "—")}</b></span><br>
                <span>🏢 División: <b>${escapeHtml(d.division || "—")}</b></span>
              </div>
              <div class="meta">
                <span>${escapeHtml(meta)}</span>
                <span style="margin-left: auto; display: flex; align-items: center; gap: 4px;">
                  ${isUnread ? '<span class="notifCheckmark">!</span>' : '<span class="notifCheckmark">✓</span>'}
                </span>
              </div>

              <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
                <button class="small secondary" type="button" data-action="viewCarpeta" data-carpeta="${escapeHtml(carpeta)}">
                  Ver todas las filas
                </button>
              </div>
            </div>
          </div>
        `;
      });

      notifList.innerHTML = notifsByGroup.join("");
    }

    // Escuchar últimas 50 notificaciones
    const notifQ = query(collection(db, "notifications"), orderBy("createdAt","desc"), limit(50));
    onSnapshot(notifQ, (snap)=>{
      notificationsCache = [];
      snap.forEach(docu => notificationsCache.push({ id: docu.id, data: docu.data() }));
      renderNotif();
    }, (e)=>{
      console.warn("No se pudieron leer notifications:", e);
    });

    // ✅ Limpiar filtros + ir a la fila + resaltar
    function clearAllFilters(){
      $("q").value = "";
      $("fDivision").value = "";
      $("fCond").value = "";
      $("fWis").value = "";
      $("fCierre").value = "";
      $("fConfirmacionLlegada").value = "";
      $("fOC").value = "";
      $("fFechaMode").value = "";
      $("fDateFrom").value = "";
      $("fDateTo").value = "";
      applyFilters();
    }

    function highlightAndScrollToRow(rowId){
      clearAllFilters();

      setTimeout(() => {
        const rowEl = document.querySelector(`tr[data-id="${CSS.escape(rowId)}"]`);
        if (!rowEl){
          showToast("No se encontró la fila en pantalla (puede estar filtrada).", true);
          return;
        }
        rowEl.scrollIntoView({ behavior: "smooth", block: "center" });
        rowEl.classList.add("rowHighlight");
        setTimeout(() => rowEl.classList.remove("rowHighlight"), 7000);
      }, 60);
    }

    function filterByCarpeta(carpeta){
      clearAllFilters();
      // Usar el campo de búsqueda para filtrar por carpeta
      $("q").value = carpeta;
      applyFilters();

      setTimeout(() => {
        // Scroll a la primera fila visible
        const firstRow = document.querySelector("tbody tr");
        if (firstRow){
          firstRow.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      }, 60);
    }

    // Delegación de eventos: botones de notificación
    notifList.addEventListener("click", async (e) => {
      const btn = e.target.closest("[data-action]");
      if (!btn) return;

      if (btn.dataset.action === "viewCarpeta") {
        const carpeta = btn.dataset.carpeta || "";
        if (!carpeta) return;
        
        // Marcar la notificación de esta carpeta como leída
        const notifForCarpeta = notificationsCache.find(n => 
          (n.data.carpeta || "").toString().trim() === carpeta
        );
        
        if (notifForCarpeta && notifForCarpeta.data.read !== true) {
          try {
            await updateDoc(doc(db, "notifications", notifForCarpeta.id), { 
              read: true, 
              readAt: serverTimestamp() 
            });
          } catch (err) {
            console.warn("Error marcando notificación como leída:", err);
          }
        }
        
        notifPanel.style.display = "none";
        filterByCarpeta(carpeta);
        return;
      }

      if (btn.dataset.action === "viewRow") {
        const rowId = btn.dataset.rowid || "";
        if (!rowId) return;
        notifPanel.style.display = "none";
        highlightAndScrollToRow(rowId);
        return;
      }
    });

    // Marcar como leída al hacer click en el item de notificación
    notifList.addEventListener("click", async (e) => {
      const notifItem = e.target.closest(".notifItem");
      if (!notifItem) return;
      
      const carpeta = notifItem.dataset.carpeta;
      if (!carpeta) return;
      
      // Si es unread y se hace click en el item (pero no en el botón)
      if (e.target.closest("[data-action]")) return; // Si fue en un botón, ignorar
      
      const notifForCarpeta = notificationsCache.find(n => 
        (n.data.carpeta || "").toString().trim() === carpeta
      );
      
      if (notifForCarpeta && notifForCarpeta.data.read !== true) {
        try {
          await updateDoc(doc(db, "notifications", notifForCarpeta.id), { 
            read: true, 
            readAt: serverTimestamp() 
          });
        } catch (err) {
          console.warn("Error marcando notificación como leída:", err);
        }
      }
    });

    // ✅ Buscar (cualquier campo) + soporte "VACIO"
    function matchesText(row, q){
      if (!q) return true;

      if (q === "vacio"){
        const fieldsToCheck = [
          row.factura, row.division, row.transporte, row.carpeta, row.dua,
          row.fecha_estimada, row.fecha_deposito, row.oc
        ];
        return fieldsToCheck.some(isEmptyVal);
      }

      const atts = (row.attachments || []).map(a => a?.name || "").join(" ");
      const packingName = row.packingAttachment?.name || "";

      const hay = [
        row.factura, row.division, row.transporte, row.carpeta, row.dua,
        row.fecha_estimada, row.fecha_deposito, row.confirmacion_llegada,
        row.oc, row.cond, row.wis, row.cierre,
        packingName, atts
      ].map(norm).join(" | ");

      return hay.includes(q);
    }

    // ✅ Fecha estimada con modo VACIO / CON / rango
    function inDateRange(row, from, to, mode){
      const d = row.fecha_estimada || "";

      if (mode === "VACIO"){
        return isEmptyVal(d);
      }
      if (mode === "CON"){
        if (isEmptyVal(d)) return false;
        if (!from && !to) return true;
      }

      if (!from && !to) return true;
      if (!d) return false;
      if (from && d < from) return false;
      if (to && d > to) return false;
      return true;
    }

    function applyFilters(){
      const q = norm($("q").value);

      const fDivision = $("fDivision").value;
      const fCond = $("fCond").value;
      const fWis = $("fWis").value;
      const fCierre = $("fCierre").value;
      const fConfirmacionLlegada = $("fConfirmacionLlegada").value;

      const fOC = norm($("fOC").value);
      const fechaMode = $("fFechaMode").value; // "" | "CON" | "VACIO"

      const from = $("fDateFrom").value || "";
      const to = $("fDateTo").value || "";

      view = cache.filter(x => {
        const r = x.data;

        if (fDivision){
          if (fDivision === "__EMPTY__"){
            if (!isEmptyVal(r.division)) return false;
          } else {
            if ((r.division || "") !== fDivision) return false;
          }
        }

        if (fCond){
          if (fCond === "__EMPTY__"){ if (!isEmptyVal(r.cond)) return false; }
          else { if ((r.cond || "") !== fCond) return false; }
        }

        if (fWis){
          if (fWis === "__EMPTY__"){ if (!isEmptyVal(r.wis)) return false; }
          else { if ((r.wis || "") !== fWis) return false; }
        }

        if (fCierre){
          if (fCierre === "__EMPTY__"){ if (!isEmptyVal(r.cierre)) return false; }
          else { if ((r.cierre || "") !== fCierre) return false; }
        }

        if (fConfirmacionLlegada){
          if (fConfirmacionLlegada === "__EMPTY__"){ if (!isEmptyVal(r.confirmacion_llegada)) return false; }
          else { if ((r.confirmacion_llegada || "") !== fConfirmacionLlegada) return false; }
        }

        if (!matchesText(r, q)) return false;

        // ✅ filtro por OC + soporte VACIO
        if (fOC){
          if (fOC === "vacio"){
            if (!isEmptyVal(r.oc)) return false;
          } else {
            if (!norm(r.oc).includes(fOC)) return false;
          }
        }

        if (!inDateRange(r, from, to, fechaMode)) return false;

        return true;
      });

      draw();
    }

    function rebuildDivisionOptions(){
      const sel = $("fDivision");
      const current = sel.value;

      const values = Array.from(new Set(cache.map(x => (x.data.division || "").trim()).filter(Boolean))).sort();

      sel.innerHTML =
        `<option value="">(Todas)</option>` +
        `<option value="__EMPTY__">(Vacío)</option>` +
        values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");

      if (current === "__EMPTY__") sel.value = "__EMPTY__";
      else if (values.includes(current)) sel.value = current;
      else sel.value = "";
    }

    ["q","fDivision","fCond","fWis","fCierre","fConfirmacionLlegada","fOC","fFechaMode","fDateFrom","fDateTo"].forEach(id=>{
      $(id).addEventListener("input", applyFilters);
      $(id).addEventListener("change", applyFilters);
    });

    $("clearFiltersBtn").addEventListener("click", ()=>{
      clearAllFilters();
    });

    async function uploadFileTo(path, file, progressLabel){
      const ref = sRef(storage, path);
      const task = uploadBytesResumable(ref, file);

      await new Promise((resolve, reject) => {
        task.on("state_changed",
          (snap) => {
            const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
            msgEl.textContent = `${progressLabel}... ${pct}%`;
          },
          (err) => reject(err),
          () => resolve()
        );
      });

      const url = await getDownloadURL(ref);
      return { name: file.name, path, url, size: file.size };
    }

    async function uploadAttachments(rowId, files){
      const out = [];
      for (const f of files){
        const path = `rows/${rowId}/attachments/${uid()}_${f.name}`;
        out.push(await uploadFileTo(path, f, "Subiendo adjuntos"));
      }
      return out;
    }

    async function uploadPacking(rowId, file){
      const path = `rows/${rowId}/packing/${uid()}_${file.name}`;
      return await uploadFileTo(path, file, "Subiendo packing");
    }

    function renderAttachmentsCell(id, r){
      const atts = r.attachments || [];
      const list = atts.length ? `
        <div class="attLinks">
          ${atts.map((a, idx) => `
            <a href="${escapeHtml(a.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(a.name || "Adjunto")}</a>
            <span class="pillX" title="Borrar adjunto" data-action="delatt" data-att-idx="${idx}">×</span>
          `).join("")}
        </div>
      ` : `<span class="muted">—</span>`;

      return `
        ${list}
        <div style="margin-top:6px">
          <button class="small secondary" data-action="upatts" data-id="${id}">
            ${atts.length ? "Agregar adjuntos" : "Subir adjuntos"}
          </button>
        </div>
      `;
    }

    function renderPackingCell(id, r){
      const p = r.packingAttachment;
      if (!p?.url){
        return `
          <span class="muted">—</span>
          <div style="margin-top:6px">
            <button class="small secondary" data-action="uppacking" data-id="${id}">Subir packing</button>
          </div>
        `;
      }
      return `
        <div class="attLinks">
          <a href="${escapeHtml(p.url)}" target="_blank" rel="noopener noreferrer">XLSX</a>
          <span class="pillX" title="Borrar packing" data-action="delpacking">×</span>
        </div>
        <div style="margin-top:6px">
          <button class="small secondary" data-action="uppacking" data-id="${id}">Reemplazar</button>
        </div>
      `;
    }

    // ✅ AUDITORÍA
    async function logAudit(action, rowId, beforeData, afterData){
      try{
        const auditId = `${rowId}_${Date.now()}_${uid()}`;
        await setDoc(doc(db, "rows_audit", auditId), {
          rowId,
          action,
          before: beforeData || null,
          after: afterData || null,
          at: serverTimestamp()
        });
      } catch (e) {
        console.warn("Audit log failed:", e);
      }
    }

    // ✅ Agregar fila
    addBtn.addEventListener("click", async () => {
      const data = {
        factura: $("factura").value.trim(),
        division: $("division").value.trim(),
        transporte: $("transporte").value.trim(),
        carpeta: $("carpeta").value.trim(),
        dua: $("dua").value.trim(),
        fecha_estimada: $("fecha_estimada").value || "",
        fecha_deposito: $("fecha_deposito").value || "",
        oc: $("oc").value.trim(),

        cierre: safeYesNo($("cierre").value),
        cond: safeYesNo($("cond").value),
        wis: safeYesNo($("wis").value),
        confirmacion_llegada: safeYesNo($("confirmacion_llegada").value),

        packingAttachment: null,
        attachments: [],

        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      const empty =
        !data.factura && !data.division && !data.transporte && !data.carpeta &&
        !data.dua && !data.fecha_estimada && !data.fecha_deposito &&
        !data.oc;

      if (empty) { alert("Ingresá al menos un dato para agregar."); return; }

      addBtn.disabled = true;
      msgEl.textContent = "Guardando...";

      try {
        const docRef = await addDoc(collection(db, "rows"), data);
        await logAudit("create", docRef.id, null, { ...data, createdAt: null, updatedAt: null });

        // ✅ Si se crea ya con SI, también notifica
        if ((data.confirmacion_llegada || "NO").toUpperCase() === "SI"){
          await createNotificationForArrival(docRef.id, data);
          beep();
          await browserNotifyArribo(data);
          if (!document.hidden) showArrivalNotice(data);
          else { startTitleBlink(); showToast("🚜 ARRIBO/LLEGADA confirmada (ver pestaña)", false); }
        }

        clearAddForm();
        showToast("Agregado con éxito");
      } catch (e) {
        console.error("ERROR:", e);
        showToast(`Error: ${errText(e)}`, true);
        alert(errText(e));
      } finally {
        addBtn.disabled = false;
        msgEl.textContent = "";
      }
    });

    function renderRow(id, r) {
      const dt = r.createdAt?.toDate ? r.createdAt.toDate() : null;
      const dtTxt = dt ? formatDateVal(dt) : "";
      const isEditing = (editingRowId === id);

      if (!isEditing) {
        return `
          <tr data-id="${id}">
            <td><div class="cellInner">${escapeHtml(dtTxt)}</div></td>
            <td><div class="cellInner">${escapeHtml(r.factura)}</div></td>
            <td><div class="cellInner">${escapeHtml(r.division)}</div></td>
            <td><div class="cellInner">${escapeHtml(r.transporte)}</div></td>
            <td><div class="cellInner">${escapeHtml(r.carpeta)}</div></td>
            <td><div class="cellInner">${escapeHtml(r.dua)}</div></td>
            <td><div class="cellInner">${escapeHtml(formatDateVal(r.fecha_estimada))}</div></td>
            <td><div class="cellInner">${escapeHtml(r.oc)}</div></td>

            <td><div class="cellInner">${escapeHtml(r.cierre)}</div></td>
            <td><div class="cellInner">${escapeHtml(r.cond)}</div></td>
            <td><div class="cellInner">${escapeHtml(r.wis)}</div></td>

            <td><div class="cellInner">${escapeHtml(formatDateVal(r.fecha_deposito))}</div></td>
            <td><div class="cellInner">${escapeHtml(r.confirmacion_llegada)}</div></td>

            <td><div class="cellInner">${renderPackingCell(id, r)}</div></td>
            <td><div class="cellInner">${renderAttachmentsCell(id, r)}</div></td>

            <td>
              <div class="cellInner">
                <div class="actions">
                  <button class="small secondary" data-action="edit" title="Editar">✏️</button>
                </div>
              </div>
            </td>
          </tr>
        `;
      }

      const factura = escapeHtml(r.factura || "");
      const division = escapeHtml(r.division || "");
      const transporte = escapeHtml(r.transporte || "");
      const carpeta = escapeHtml(r.carpeta || "");
      const dua = escapeHtml(r.dua || "");
      const fecha_estimada = escapeHtml(r.fecha_estimada || "");
      const fecha_deposito = escapeHtml(r.fecha_deposito || "");
      const oc = escapeHtml(r.oc || "");

      const cierre = safeYesNo(r.cierre || "SI");
      const cond = safeYesNo(r.cond || "SI");
      const wis = safeYesNo(r.wis || "SI");
      const confirmacion_llegada = safeYesNo(r.confirmacion_llegada || "NO");

      return `
        <tr data-id="${id}">
          <td><div class="cellInner">${escapeHtml(dtTxt)}</div></td>
          <td><div class="cellInner"><input class="cell-input w140" data-field="factura" value="${factura}"></div></td>
          <td><div class="cellInner"><input class="cell-input w200" data-field="division" value="${division}"></div></td>
          <td><div class="cellInner"><input class="cell-input w200" data-field="transporte" value="${transporte}"></div></td>
          <td><div class="cellInner"><input class="cell-input w140" data-field="carpeta" value="${carpeta}"></div></td>
          <td><div class="cellInner"><input class="cell-input w140" data-field="dua" value="${dua}"></div></td>

          <td><div class="cellInner"><input class="cell-input w160" type="date" data-field="fecha_estimada" value="${fecha_estimada}"></div></td>
          <td><div class="cellInner"><input class="cell-input w140" data-field="oc" value="${oc}"></div></td>

          <td><div class="cellInner">
            <select class="cell-input w110" data-field="cierre">
              <option value="SI" ${cierre==="SI" ? "selected" : ""}>SI</option>
              <option value="NO" ${cierre==="NO" ? "selected" : ""}>NO</option>
            </select>
          </div></td>

          <td><div class="cellInner">
            <select class="cell-input w110" data-field="cond">
              <option value="SI" ${cond==="SI" ? "selected" : ""}>SI</option>
              <option value="NO" ${cond==="NO" ? "selected" : ""}>NO</option>
            </select>
          </div></td>

          <td><div class="cellInner">
            <select class="cell-input w110" data-field="wis">
              <option value="SI" ${wis==="SI" ? "selected" : ""}>SI</option>
              <option value="NO" ${wis==="NO" ? "selected" : ""}>NO</option>
            </select>
          </div></td>

          <td><div class="cellInner"><input class="cell-input w160" type="date" data-field="fecha_deposito" value="${fecha_deposito}"></div></td>

          <td><div class="cellInner">
            <select class="cell-input w160" data-field="confirmacion_llegada">
              <option value="SI" ${confirmacion_llegada==="SI" ? "selected" : ""}>SI</option>
              <option value="NO" ${confirmacion_llegada==="NO" ? "selected" : ""}>NO</option>
            </select>
          </div></td>

          <td><div class="cellInner">${renderPackingCell(id, r)}</div></td>
          <td><div class="cellInner">${renderAttachmentsCell(id, r)}</div></td>

          <td>
            <div class="cellInner">
              <div class="actions">
                <button class="small primary" data-action="save">Guardar</button>
                <button class="small" data-action="cancel">Cancelar</button>
                <button class="small danger" data-action="delete">Eliminar</button>
              </div>
            </div>
          </td>
        </tr>
      `;
    }

    function draw() {
      const dataToDraw = (view.length ? view : cache);
      tbody.innerHTML = dataToDraw.map(x => renderRow(x.id, x.data)).join("");
    }

    const qSnap = query(collection(db, "rows"), orderBy("createdAt", "desc"));
    onSnapshot(qSnap, (snap) => {
      cache = [];
      snap.forEach(d => cache.push({ id: d.id, data: d.data() }));
      rebuildDivisionOptions();
      applyFilters();
    }, (err) => {
      console.error(err);
      showToast("No se pudo leer Firestore", true);
    });

    // ✅ EXPORT XLSX
    function rowsForExport(){
      const dataToExport = (view.length ? view : cache);

      return dataToExport.map(x => {
        const r = x.data;
        const created = r.createdAt?.toDate ? r.createdAt.toDate() : null;

        const packing = r.packingAttachment?.name || "";
        const attachments = (r.attachments || []).map(a => a?.name || "").join(" | ");

        return {
          "ID": x.id,
          "Fecha carga": created ? formatDateVal(created) : "",
          "Factura": r.factura || "",
          "División": r.division || "",
          "Transporte": r.transporte || "",
          "Carpeta": r.carpeta || "",
          "DUA": r.dua || "",
          "Fecha estimada UY": formatDateVal(r.fecha_estimada || ""),
          "Orden compra": r.oc || "",
          "Cierre carpeta": r.cierre || "",
          "Condiciones": r.cond || "",
          "WIS": r.wis || "",
          "Fecha depósito": formatDateVal(r.fecha_deposito || ""),
          "Confirmación de llegada": r.confirmacion_llegada || "",
          "Packing (nombre)": packing,
          "Adjuntos (nombres)": attachments
        };
      });
    }

    function exportXlsx(){
      const data = rowsForExport();
      if (!data.length){
        alert("No hay datos para exportar.");
        return;
      }

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Datos");

      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const dd = String(now.getDate()).padStart(2,'0');
      const filename = `carga_datos_${yyyy}-${mm}-${dd}.xlsx`;

      XLSX.writeFile(wb, filename);
    }
    $("exportXlsxBtn").addEventListener("click", exportXlsx);

    // pickers
    $("packingRowPicker").addEventListener("change", async (e) => {
      const f = (e.target.files || [])[0];
      $("packingRowPicker").value = "";
      if (!pendingPackingRowId) return;
      if (!f) { pendingPackingRowId = null; return; }

      if (!isExcelFile(f)){
        alert("Solo se permite Excel (.xls o .xlsx).");
        pendingPackingRowId = null;
        return;
      }

      const rowId = pendingPackingRowId;
      pendingPackingRowId = null;

      const row = cache.find(x => x.id === rowId);
      const prev = row?.data?.packingAttachment;

      try{
        msgEl.textContent = "Subiendo packing...";
        if (prev?.path){
          await deleteObject(sRef(storage, prev.path));
        }
        const uploaded = await uploadPacking(rowId, f);

        const beforeSnap = await getDoc(doc(db, "rows", rowId));
        const beforeData = beforeSnap.exists() ? beforeSnap.data() : null;

        await updateDoc(doc(db, "rows", rowId), { packingAttachment: uploaded, updatedAt: serverTimestamp() });

        await logAudit("update", rowId, beforeData, {
          ...(beforeData || {}),
          packingAttachment: uploaded,
          updatedAt: null
        });

        showToast("Packing actualizado");
      } catch(err){
        console.error(err);
        showToast(`Error: ${errText(err)}`, true);
        alert(errText(err));
      } finally {
        msgEl.textContent = "";
      }
    });

    $("attRowPicker").addEventListener("change", async (e) => {
      const files = Array.from(e.target.files || []);
      $("attRowPicker").value = "";
      if (!pendingAttRowId) return;
      if (!files.length) { pendingAttRowId = null; return; }

      const rowId = pendingAttRowId;
      pendingAttRowId = null;

      const row = cache.find(x => x.id === rowId);
      const current = row?.data?.attachments || [];

      try{
        msgEl.textContent = "Subiendo adjuntos...";
        const uploaded = await uploadAttachments(rowId, files);
        const next = current.concat(uploaded);

        const beforeSnap = await getDoc(doc(db, "rows", rowId));
        const beforeData = beforeSnap.exists() ? beforeSnap.data() : null;

        await updateDoc(doc(db, "rows", rowId), { attachments: next, updatedAt: serverTimestamp() });

        await logAudit("update", rowId, beforeData, {
          ...(beforeData || {}),
          attachments: next,
          updatedAt: null
        });

        showToast("Adjuntos actualizados");
      } catch(err){
        console.error(err);
        showToast(`Error: ${errText(err)}`, true);
        alert(errText(err));
      } finally {
        msgEl.textContent = "";
      }
    });

    tbody.addEventListener("click", async (e) => {
      const btn = e.target.closest("[data-action]");
      if (!btn) return;

      const tr = e.target.closest("tr[data-id]");
      if (!tr) return;

      const id = tr.dataset.id;
      const action = btn.dataset.action;

      if (action === "edit") { editingRowId = id; draw(); return; }
      if (action === "cancel") { editingRowId = null; draw(); return; }

      if (action === "uppacking"){
        pendingPackingRowId = id;
        $("packingRowPicker").click();
        return;
      }

      if (action === "upatts"){
        pendingAttRowId = id;
        $("attRowPicker").click();
        return;
      }

      if (action === "delpacking"){
        const row = cache.find(x => x.id === id);
        const p = row?.data?.packingAttachment;
        if (!p?.path) return;
        if (!confirm(`¿Borrar packing "${p.name}"?`)) return;
        try{
          btn.disabled = true;

          const beforeSnap = await getDoc(doc(db, "rows", id));
          const beforeData = beforeSnap.exists() ? beforeSnap.data() : null;

          await deleteObject(sRef(storage, p.path));
          await updateDoc(doc(db, "rows", id), { packingAttachment: null, updatedAt: serverTimestamp() });

          await logAudit("update", id, beforeData, {
            ...(beforeData || {}),
            packingAttachment: null,
            updatedAt: null
          });

          showToast("Packing borrado");
        } catch(err){
          console.error(err);
          showToast(`Error: ${errText(err)}`, true);
          alert(errText(err));
        } finally {
          btn.disabled = false;
        }
        return;
      }

      if (action === "delatt"){
        const idx = Number(btn.dataset.attIdx);
        const row = cache.find(x => x.id === id);
        const atts = row?.data?.attachments || [];
        const att = atts[idx];
        if (!att?.path) return;

        if (!confirm(`¿Borrar adjunto "${att.name}"?`)) return;

        try{
          btn.disabled = true;

          const beforeSnap = await getDoc(doc(db, "rows", id));
          const beforeData = beforeSnap.exists() ? beforeSnap.data() : null;

          await deleteObject(sRef(storage, att.path));
          const next = atts.filter((_, i) => i !== idx);
          await updateDoc(doc(db, "rows", id), { attachments: next, updatedAt: serverTimestamp() });

          await logAudit("update", id, beforeData, {
            ...(beforeData || {}),
            attachments: next,
            updatedAt: null
          });

          showToast("Adjunto borrado");
        } catch(err){
          console.error(err);
          showToast(`Error: ${errText(err)}`, true);
          alert(errText(err));
        } finally {
          btn.disabled = false;
        }
        return;
      }

      if (action === "save") {
        const fields = tr.querySelectorAll("[data-field]");
        const updated = {};
        fields.forEach(el => updated[el.dataset.field] = (el.value ?? "").toString().trim());

        updated.cond = safeYesNo(updated.cond);
        updated.wis  = safeYesNo(updated.wis);
        updated.cierre  = safeYesNo(updated.cierre);
        updated.confirmacion_llegada = safeYesNo(updated.confirmacion_llegada);

        try {
          btn.disabled = true;

          const beforeSnap = await getDoc(doc(db, "rows", id));
          const beforeData = beforeSnap.exists() ? beforeSnap.data() : null;
          const beforeVal = (beforeData?.confirmacion_llegada || "NO").toString().trim().toUpperCase();
          const afterVal = (updated.confirmacion_llegada || "NO").toString().trim().toUpperCase();

          await updateDoc(doc(db, "rows", id), { ...updated, updatedAt: serverTimestamp() });

          await logAudit("update", id, beforeData, {
            ...(beforeData || {}),
            ...updated,
            updatedAt: null
          });

          // ✅ Si cambió de NO->SI: crear notificación global + windows + aviso grande
          if (beforeVal !== "SI" && afterVal === "SI") {
            const merged = { ...(beforeData || {}), ...updated };
            await createNotificationForArrival(id, merged);

            beep();
            await browserNotifyArribo(merged);

            if (!document.hidden) {
              showArrivalNotice(merged);
            } else {
              startTitleBlink();
              showToast("🚜 ARRIBO/LLEGADA confirmada (ver pestaña)", false);
            }
          }

          editingRowId = null;
          showToast("Modificado con éxito");
        } catch (err) {
          console.error(err);
          showToast(`Error: ${errText(err)}`, true);
          alert(errText(err));
        } finally {
          btn.disabled = false;
        }
        return;
      }

      if (action === "delete") {
        const row = cache.find(x => x.id === id);
        const atts = row?.data?.attachments || [];
        const p = row?.data?.packingAttachment;

        if (!confirm("¿Seguro que querés eliminar esta fila? (Borra adjuntos y packing también)")) return;

        try{
          btn.disabled = true;

          const beforeSnap = await getDoc(doc(db, "rows", id));
          const beforeData = beforeSnap.exists() ? beforeSnap.data() : null;

          for (const a of atts) {
            if (a?.path) await deleteObject(sRef(storage, a.path));
          }
          if (p?.path) await deleteObject(sRef(storage, p.path));

          await deleteDoc(doc(db, "rows", id));

          await logAudit("delete", id, beforeData, null);

          if (editingRowId === id) editingRowId = null;
          showToast("Eliminado con éxito");
        } catch(err){
          console.error(err);
          showToast(`Error: ${errText(err)}`, true);
          alert(errText(err));
        } finally {
          btn.disabled = false;
        }
      }
    });
  </script>
</body>
</html>
