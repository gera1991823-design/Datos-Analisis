<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reservas de Importaciones</title>

  <!-- XLSX (SheetJS) para exportar a Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- âœ… ESTILO CLARO (el del "Reclamos") aplicado a Reservas -->
  <style>
    :root{
      /* Interagrovial / John Deere-ish accents */
      --green:#367C2B;
      --yellow:#FFDE00;

      /* light ui */
      --bg1:#eef2f5;
      --bg2:#e6edf2;
      --panel:#ffffff;
      --panel2:#f8fbfd;

      --text:#0b1220;
      --muted:#5a6876;

      --line:rgba(10,40,20,.12);
      --radius:16px;
      --shadow: 0 14px 34px rgba(0,0,0,.10);
      --shadow2: 0 8px 18px rgba(0,0,0,.08);

      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 0%, rgba(54,124,43,.12), transparent 60%),
        radial-gradient(700px 500px at 85% 10%, rgba(255,222,0,.10), transparent 55%),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
    }

    .wrap{ width:100%; padding:16px; }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:12px;
      padding:14px 16px;
      border-radius:18px;
      background:linear-gradient(90deg, rgba(54,124,43,.16), rgba(255,222,0,.10));
      border:1px solid rgba(54,124,43,.18);
      box-shadow:var(--shadow2);
      margin-bottom:14px;
    }
    .titleRow{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .titleCol{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    h1{
      margin:0;
      font-size:26px;
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.2;
    }
    .subpill{
      font-size:12px;
      border:1px solid rgba(54,124,43,.22);
      border-radius:999px;
      padding:6px 12px;
      color:var(--muted);
      background:rgba(255,255,255,.65);
      white-space:nowrap;
    }

    /* Cards */
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(248,251,253,.92));
      border:1px solid rgba(10,40,20,.10);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      margin-bottom:14px;
      overflow:hidden;
    }

    /* Meta row (status) */
    .meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      padding:12px 14px;
      border-radius:14px;
      background:linear-gradient(90deg, rgba(54,124,43,.10), rgba(255,255,255,.55));
      border:1px solid rgba(10,40,20,.10);
      margin-bottom:12px;
    }

    .pill{
      font-size:12px;
      border:1px solid rgba(10,40,20,.12);
      border-radius:999px;
      padding:6px 12px;
      color:var(--muted);
      background:rgba(255,255,255,.70);
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }

    .dot{
      width:8px; height:8px; border-radius:999px;
      background:var(--yellow);
      box-shadow:0 0 0 6px rgba(255,222,0,.14);
    }

    /* Controls */
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }

    input, select{
      height:40px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(10,40,20,.14);
      background:rgba(255,255,255,.92);
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(54,124,43,.08);
      font-size:13px;
      color:var(--text);
    }
    input::placeholder{ color:rgba(90,104,118,.55); }
    input:focus, select:focus{
      border-color:rgba(54,124,43,.40);
      box-shadow:0 0 0 4px rgba(54,124,43,.12);
    }

    button{
      border:0;
      cursor:pointer;
      user-select:none;
      font-family:var(--sans);
    }

    .primary, .secondary, .danger{
      height:40px;
      border-radius:12px;
      padding:0 14px;
      font-size:13px;
      font-weight:600;
      border:1px solid rgba(10,40,20,.14);
      box-shadow: var(--shadow2);
      transition:.15s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
    }
    .primary{
      background:linear-gradient(135deg, rgba(54,124,43,.92), rgba(54,124,43,.72));
      color:#fff;
      border-color:rgba(54,124,43,.35);
    }
    .secondary{
      background:rgba(255,255,255,.92);
      color:var(--text);
    }
    .danger{
      background:linear-gradient(135deg, rgba(180,40,40,.22), rgba(255,255,255,.92));
      border-color:rgba(180,40,40,.30);
      color:#8a1d1d;
    }
    .primary:hover, .secondary:hover, .danger:hover{
      transform:translateY(-1px);
      box-shadow: 0 12px 26px rgba(0,0,0,.12);
    }

    /* Table */
    .tableWrap{
      width:100%;
      overflow:auto;
      max-height: calc(100vh - 280px);
    }
    table{
      width:100%;
      min-width:1500px;
      border-collapse:separate;
      border-spacing:0;
      font-size:13px;
    }

    thead th{
      position:sticky;
      top:0;
      z-index:5;
      background:linear-gradient(180deg, rgba(54,124,43,.90), rgba(30,90,30,.90));
      color:#fff;
      padding:11px 10px;
      border-bottom:2px solid var(--yellow);
      white-space:nowrap;
      font-weight:800;
      text-align:center;
    }

    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(10,40,20,.08);
      background:rgba(255,255,255,.82);
      white-space:nowrap;
      vertical-align:middle;
      text-align:center;
    }
    tbody tr:nth-child(even) td{ background:rgba(248,251,253,.92); }
    tbody tr:hover td{ background:rgba(54,124,43,.08); }

    tbody td[contenteditable="true"]:focus{
      outline:2px solid rgba(54,124,43,.35);
      border-radius:10px;
      background: rgba(255,255,255,.98);
    }

    .col-small{ width: 120px; }
    .col-xs{ width: 90px; }
    .col-mid{ width: 160px; }
    .col-wide{ width: 240px; }

    .jd-select{
      width:100%;
      min-width:150px;
      background:rgba(255,255,255,.92);
      color:var(--text);
      border:1px solid rgba(10,40,20,.14);
      border-radius:10px;
      padding:6px 10px;
      outline:none;
      text-align:center;
    }
    .jd-select:focus{
      border-color:rgba(54,124,43,.40);
      box-shadow:0 0 0 3px rgba(54,124,43,.12);
    }

    .row-actions{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:center;
    }
    .icon-btn{
      width:34px; height:34px;
      border-radius:10px;
      border:1px solid rgba(10,40,20,.14);
      background:rgba(255,255,255,.92);
      color:var(--text);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:.15s ease;
      box-shadow: var(--shadow2);
    }
    .icon-btn:hover{
      border-color:rgba(54,124,43,.35);
      transform:translateY(-1px);
    }
    .icon-btn.danger{
      border-color:rgba(180,40,40,.30);
      background:rgba(180,40,40,.10);
      color:#8a1d1d;
    }

    .footer{
      margin-top:12px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(10,40,20,.10);
      background:rgba(255,255,255,.70);
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .footer code{ font-family:var(--mono); color:var(--text); }

    @media (max-width: 900px){
      .toolbar{ justify-content:stretch; }
      input, select, .primary, .secondary, .danger{ width:100%; }
      table{ min-width: 1400px; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- âœ… HEADER estilo "Reclamos" -->
    <div class="topbar">
      <div class="titleRow">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none"
             xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <rect x="1" y="3" width="22" height="18" rx="2"
                stroke="currentColor" stroke-width="1.2" fill="#fff" />
          <path d="M6 8h6M6 12h12M6 16h6"
                stroke="#367c2b" stroke-width="1.4"
                stroke-linecap="round" stroke-linejoin="round"/>
        </svg>

        <div class="titleCol">
          <h1>Reservas de Importaciones</h1>
          <p class="subtitle">Tabla editable Â· buscador + filtro Â· exportaciÃ³n Excel (XLSX) Â· sincroniza en vivo (Firestore)</p>
        </div>
      </div>

      <div class="toolbar">
        <input id="search" style="min-width:260px" placeholder="Buscar (caja, material, OC, descripciÃ³n...)" />
        <select id="filterCumplido">
          <option value="all">Cumplido: Todos</option>
          <option value="si">Cumplido: SÃ­</option>
          <option value="no">Cumplido: No</option>
          <option value="sin realizar">Cumplido: Sin realizar</option>
        </select>

        <button class="primary" id="addRow">ï¼‹ Agregar fila</button>
        <button class="secondary" id="exportXlsx">â¬‡ Exportar XLSX</button>
        <button class="danger" id="clearAll">ðŸ—‘ Vaciar</button>
      </div>
    </div>

    <div class="card">
      <div class="meta">
        <div class="pill"><span class="dot"></span> Vista principal</div>
        <div class="pill">Filas: <strong id="rowCount" style="color:var(--text)">0</strong></div>
        <div class="pill">Estado: <strong id="syncStatus" style="color:var(--text)">Conectandoâ€¦</strong></div>
      </div>

      <div class="tableWrap">
        <table id="grid">
          <thead>
            <tr>
              <th class="col-small">Caja</th>
              <th class="col-small">Material</th>
              <th class="col-xs">Cantidad pack</th>
              <th class="col-xs">Cantid</th>
              <th class="col-wide">DescripciÃ³n</th>
              <th class="col-wide">Comentario</th>
              <th class="col-mid">O/C</th>
              <th class="col-xs">Carpeta</th>
              <th class="col-mid">Pedido Trasla</th>
              <th class="col-xs">Sucurs</th>
              <th class="col-mid">Fecha</th>
              <th class="col-mid">Hora de carga</th>
              <th class="col-small">Cumplido</th>
              <th class="col-xs">AcciÃ³n</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="footer">
        <div>Tip: click en una celda para editar. Enter confirma. Cambios se sincronizan para todas las PCs.</div>
        <div>Back-end: <code>Firebase Firestore</code></div>
      </div>
    </div>
  </div>

  <!-- IMPORTANTE:
       Este script usa "type=module" (Firebase v9+). No lo abras con file://
       Abrilo desde un servidor/hosting (GitHub Pages sirve). -->
  <script type="module">
    // =========================
    // FIREBASE (Firestore realtime + Auth anÃ³nimo)
    // =========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      addDoc,
      updateDoc,
      deleteDoc,
      onSnapshot,
      query,
      orderBy,
      serverTimestamp,
      getDocs,
      writeBatch,
      limit
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // ==== TU firebaseConfig (tal cual lo pasaste) ====
    const firebaseConfig = {
      apiKey: "AIzaSyA0xgTpM2NjDoyBD5Eo5F2FN-Dxy6UgI9Y",
      authDomain: "reservas-importaciones.firebaseapp.com",
      projectId: "reservas-importaciones",
      storageBucket: "reservas-importaciones.firebasestorage.app",
      messagingSenderId: "404230429294",
      appId: "1:404230429294:web:c11b2d0c15a43ce0f6247f",
      measurementId: "G-S05S1H4XZ0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // =========================
    // TU APP (misma lÃ³gica)
    // =========================
    const columns = [
      "caja","material","cantidadPack","cantid","descripcion","comentario",
      "oc","carpeta","pedidoTrasla","sucurs","fecha","horaCarga","cumplido"
    ];

    const tbody = document.getElementById("tbody");
    const search = document.getElementById("search");
    const filterCumplido = document.getElementById("filterCumplido");
    const rowCount = document.getElementById("rowCount");
    const syncStatus = document.getElementById("syncStatus");

    function pad2(n){ return String(n).padStart(2,"0"); }

    function nowDateStr(){
      const d = new Date();
      return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
    }

    function nowTimeStr(){
      const d = new Date();
      return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }

    function seedData(){
      return [{
        caja:"SBKM5D",
        material:"KK25029",
        cantidadPack:"4",
        cantid:"2",
        descripcion:"APOYO",
        comentario:"",
        oc:"1200021702",
        carpeta:"88789",
        pedidoTrasla:"1601220470",
        sucurs:"S002",
        fecha:"27/11/2025",
        horaCarga:"08:30",
        cumplido:"SIN REALIZAR"
      }];
    }

    // Datos en memoria (la fuente real es Firestore)
    let data = [];

    // ColecciÃ³n donde se guardan filas
    const reservasCol = collection(db, "reservas");
    const reservasQuery = query(reservasCol, orderBy("createdAt", "desc"));

    function matchesFilters(row){
      const q = search.value.trim().toLowerCase();
      const f = filterCumplido.value;

      const haystack = columns.map(k => (row[k] ?? "").toString().toLowerCase()).join(" | ");
      const okSearch = !q || haystack.includes(q);

      let okCumplido = true;
      if(f !== "all"){
        const v = (row.cumplido ?? "").toString().trim().toLowerCase();
        const isYes = (v === "si" || v === "sÃ­");
        const isNo = (v === "no");
        const isPending = (v === "sin realizar" || v === "");
        if(f === "si") okCumplido = isYes;
        if(f === "no") okCumplido = isNo;
        if(f === "sin realizar") okCumplido = isPending;
      }

      return okSearch && okCumplido;
    }

    function render(){
      tbody.innerHTML = "";

      const visible = data
        .map((row, idx) => ({row, idx}))
        .filter(({row}) => matchesFilters(row));

      rowCount.textContent = visible.length;

      for(const {row, idx} of visible){
        const tr = document.createElement("tr");

        for(const key of columns){
          const td = document.createElement("td");
          td.setAttribute("data-key", key);
          td.setAttribute("data-idx", idx);

          if(key === "cumplido"){
            const current = (row[key] ?? "SIN REALIZAR").toString().trim().toUpperCase();
            const normalized = (current === "" ? "SIN REALIZAR" : current);

            td.innerHTML = `
              <select class="jd-select" data-idx="${idx}" data-key="cumplido" aria-label="Cumplido">
                <option value="SIN REALIZAR" ${normalized === "SIN REALIZAR" ? "selected" : ""}>SIN REALIZAR</option>
                <option value="SI" ${normalized === "SI" ? "selected" : ""}>SI</option>
                <option value="NO" ${normalized === "NO" ? "selected" : ""}>NO</option>
              </select>
            `;
          }else{
            td.textContent = row[key] ?? "";
            td.contentEditable = "true";
          }

          tr.appendChild(td);
        }

        const tdA = document.createElement("td");
        tdA.className = "col-xs";
        tdA.innerHTML = `
          <div class="row-actions">
            <button class="icon-btn" title="Duplicar" data-action="dup" data-idx="${idx}">âŽ˜</button>
            <button class="icon-btn danger" title="Eliminar" data-action="del" data-idx="${idx}">âœ•</button>
          </div>
        `;
        tr.appendChild(tdA);

        tbody.appendChild(tr);
      }
    }

    // =========================
    // FIRESTORE: Seed inicial si estÃ¡ vacÃ­o
    // =========================
    async function ensureSeedIfEmpty(){
      const q1 = query(reservasCol, limit(1));
      const snap = await getDocs(q1);
      if(snap.size > 0) return;

      const seed = seedData();
      for(const row of seed){
        await addDoc(reservasCol, {
          ...row,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
      }
    }

    // =========================
    // FIRESTORE: realtime listener
    // =========================
    async function startRealtime(){
      try{
        syncStatus.textContent = "Autenticandoâ€¦";
        await signInAnonymously(auth);

        syncStatus.textContent = "Cargandoâ€¦";
        await ensureSeedIfEmpty();

        syncStatus.textContent = "En vivo âœ…";

        onSnapshot(reservasQuery, (snap) => {
          data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          render();
        }, (err) => {
          console.error(err);
          syncStatus.textContent = "Error ðŸ”´";
          alert("Error de sincronizaciÃ³n. RevisÃ¡ reglas de Firestore/credenciales.");
        });

      }catch(err){
        console.error(err);
        syncStatus.textContent = "Error ðŸ”´";
        alert("No se pudo conectar a Firebase. RevisÃ¡ firebaseConfig y reglas.");
      }
    }

    // =========================
    // EDITAR: updateDoc al salir de celda
    // =========================
    tbody.addEventListener("focusout", async (e) => {
      const td = e.target.closest("td");
      if(!td || !td.dataset.key) return;

      const idx = Number(td.dataset.idx);
      const key = td.dataset.key;

      if(!Number.isFinite(idx) || !data[idx]) return;
      if(key === "cumplido") return;

      const rowId = data[idx].id;
      const value = td.innerText.trim();

      try{
        await updateDoc(doc(db, "reservas", rowId), {
          [key]: value,
          updatedAt: serverTimestamp()
        });
      }catch(err){
        console.error(err);
        alert("No se pudo guardar el cambio (Firestore).");
      }
    });

    // Enter: evitar saltos de lÃ­nea
    tbody.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        e.target.blur();
      }
    });

    // Cumplido: guardar por cambio del select
    tbody.addEventListener("change", async (e) => {
      const sel = e.target.closest("select.jd-select");
      if(!sel) return;

      const idx = Number(sel.dataset.idx);
      if(!Number.isFinite(idx) || !data[idx]) return;

      const rowId = data[idx].id;

      try{
        await updateDoc(doc(db, "reservas", rowId), {
          cumplido: sel.value,
          updatedAt: serverTimestamp()
        });
      }catch(err){
        console.error(err);
        alert("No se pudo guardar 'Cumplido'.");
      }
    });

    // Duplicar / Eliminar
    tbody.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-action]");
      if(!btn) return;

      const action = btn.dataset.action;
      const idx = Number(btn.dataset.idx);
      if(!Number.isFinite(idx) || !data[idx]) return;

      const row = data[idx];

      if(action === "del"){
        if(!confirm("Â¿Eliminar esta fila?")) return;
        try{
          await deleteDoc(doc(db, "reservas", row.id));
        }catch(err){
          console.error(err);
          alert("No se pudo eliminar.");
        }
      }

      if(action === "dup"){
        const copy = structuredClone(row);
        delete copy.id;
        delete copy.createdAt;
        delete copy.updatedAt;

        try{
          await addDoc(reservasCol, {
            ...copy,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
        }catch(err){
          console.error(err);
          alert("No se pudo duplicar.");
        }
      }
    });

    // Agregar fila
    document.getElementById("addRow").addEventListener("click", async () => {
      const empty = Object.fromEntries(columns.map(c => [c, ""]));
      empty.cumplido = "SIN REALIZAR";
      empty.fecha = nowDateStr();
      empty.horaCarga = nowTimeStr();

      try{
        await addDoc(reservasCol, {
          ...empty,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
      }catch(err){
        console.error(err);
        alert("No se pudo agregar la fila.");
      }
    });

    // Vaciar todo (borra todos los docs de la colecciÃ³n en lotes de 500)
    document.getElementById("clearAll").addEventListener("click", async () => {
      if(!confirm("Â¿Seguro que querÃ©s vaciar toda la tabla? (se borra para TODOS)")) return;

      try{
        syncStatus.textContent = "Vaciandoâ€¦";

        const snap = await getDocs(reservasCol);
        const docs = snap.docs;

        const CHUNK = 500;
        for(let i=0; i<docs.length; i+=CHUNK){
          const batch = writeBatch(db);
          const chunk = docs.slice(i, i+CHUNK);
          for(const d of chunk){
            batch.delete(d.ref);
          }
          await batch.commit();
        }

        syncStatus.textContent = "En vivo âœ…";
      }catch(err){
        console.error(err);
        syncStatus.textContent = "Error ðŸ”´";
        alert("No se pudo vaciar. RevisÃ¡ reglas/permisos.");
      }
    });

    // Filtros UI
    search.addEventListener("input", render);
    filterCumplido.addEventListener("change", render);

    /* =========================
       EXPORTAR XLSX (tu mismo cÃ³digo)
    ========================== */
    function parseDateDMY(s){
      const str = (s ?? "").toString().trim();
      const m = str.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if(!m) return null;
      const dd = Number(m[1]), mm = Number(m[2]), yyyy = Number(m[3]);
      const d = new Date(yyyy, mm-1, dd);
      return Number.isFinite(d.getTime()) ? d : null;
    }

    function parseTimeHMToExcel(s){
      const str = (s ?? "").toString().trim();
      const m = str.match(/^(\d{1,2}):(\d{2})$/);
      if(!m) return null;
      const hh = Number(m[1]), mi = Number(m[2]);
      if(hh < 0 || hh > 23 || mi < 0 || mi > 59) return null;
      return (hh * 3600 + mi * 60) / 86400;
    }

    function autoColsFromAOA(aoa){
      const colCount = Math.max(...aoa.map(r => r.length));
      const maxLen = new Array(colCount).fill(0);

      for(const row of aoa){
        for(let c=0; c<colCount; c++){
          const v = row[c];
          let len = 0;

          if(v == null) len = 0;
          else if(v instanceof Date) len = 10;
          else if(typeof v === "number") len = 5;
          else len = String(v).length;

          if(len > maxLen[c]) maxLen[c] = len;
        }
      }

      return maxLen.map(n => ({
        wch: Math.min(40, Math.max(10, n + 2))
      }));
    }

    document.getElementById("exportXlsx").addEventListener("click", () => {
      const rows = data.filter(matchesFilters);

      const header = [
        "Caja","Material","Cantidad pack","Cantid","DescripciÃ³n","Comentario",
        "O/C","Carpeta","Pedido Trasla","Sucurs","Fecha","Hora de carga","Cumplido"
      ];

      const aoa = [
        header,
        ...rows.map(r => ([
          r.caja ?? "",
          r.material ?? "",
          r.cantidadPack ?? "",
          r.cantid ?? "",
          r.descripcion ?? "",
          r.comentario ?? "",
          r.oc ?? "",
          r.carpeta ?? "",
          r.pedidoTrasla ?? "",
          r.sucurs ?? "",
          parseDateDMY(r.fecha) ?? "",
          parseTimeHMToExcel(r.horaCarga) ?? "",
          r.cumplido ?? ""
        ]))
      ];

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(aoa, { cellDates: true });

      const range = XLSX.utils.decode_range(ws["!ref"]);
      for(let R = range.s.r + 1; R <= range.e.r; R++){
        const dateCellAddr = XLSX.utils.encode_cell({ r:R, c:10 });
        const timeCellAddr = XLSX.utils.encode_cell({ r:R, c:11 });

        const dc = ws[dateCellAddr];
        if(dc && dc.v instanceof Date){
          dc.t = "d";
          dc.z = "dd/mm/yyyy";
        }

        const tc = ws[timeCellAddr];
        if(tc && typeof tc.v === "number"){
          tc.t = "n";
          tc.z = "hh:mm";
        }
      }

      ws["!freeze"] = { xSplit: 0, ySplit: 1 };
      ws["!autofilter"] = { ref: ws["!ref"] };
      ws["!cols"] = autoColsFromAOA(aoa);

      XLSX.utils.book_append_sheet(wb, ws, "Reservas");

      const d = new Date();
      const fileName = `reservas_importaciones_${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}.xlsx`;
      XLSX.writeFile(wb, fileName);
    });

    // Iniciar realtime
    startRealtime();
  </script>
</body>
</html>
